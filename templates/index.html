<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>ðŸŒ¿AI Agro Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        :root {
            --primary-color: #39ff14;
            /* Neon Green */
            --primary-hover: #32e612;
            --primary-glow: rgba(57, 255, 20, 0.6);
            --electric-blue: #00f6ff;
            --cyber-purple: #bc13fe;
            --secondary-color: #0a0a0a;
            --dark-bg: #050505;
            --glass-bg: rgba(0, 0, 0, 0.75);
            --glass-border: rgba(57, 255, 20, 0.3);
            /* Removed text-shadow */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--dark-bg);
            background-image:
                radial-gradient(circle at 50% 50%, rgba(57, 255, 20, 0.05) 0%, transparent 50%),
                linear-gradient(rgba(10, 10, 10, 0.9), rgba(10, 10, 10, 0.9)),
                url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
            color: white;
            margin: 0;
            padding: 0;
            display: flex;
            overflow-x: hidden;
            font-weight: 500;
        }

        /* Base Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
            }

            to {
                transform: translateY(0);
            }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
            }

            to {
                transform: translateX(0);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(3000deg);
            }
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.5);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }


        @keyframes scan {
            0% {
                top: 0;
            }

            100% {
                top: 100%;
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 62, 62, 0.4);
            }

            70% {
                transform: scale(1.02);
                box-shadow: 0 0 0 10px rgba(255, 62, 62, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 62, 62, 0);
            }
        }

        .scan-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            margin: 20px auto;
            overflow: hidden;
            border-radius: 12px;
            border: 2px solid var(--primary-color);
            display: none;
        }

        .scan-container img {
            width: 100%;
            display: block;
            filter: brightness(0.7);
        }

        .scan-line {
            position: absolute;
            width: 100%;
            height: 4px;
            background: var(--primary-color);
            box-shadow: 0 0 15px var(--primary-color), 0 0 30px var(--primary-color);
            z-index: 10;
            animation: scan 2s linear infinite;
            top: 0;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- NEW CHATBOT STYLES --- */
        .chatbot-toggler {
            position: fixed;
            bottom: 72px;
            right: 30px;
            z-index: 1050;
            height: 55px;
            width: 55px;
            border: none;
            outline: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            font-size: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease-in-out, background-color 0.2s;
        }

        .chatbot-toggler:hover {
            transform: scale(1.1);
            background-color: var(--primary-hover);
        }

        .chatbot-toggler span {
            position: absolute;

        }

        .show-chatbot .chatbot-toggler span:first-child,
        .chatbot-toggler span:last-child {
            opacity: 0;
        }

        .show-chatbot .chatbot-toggler span:last-child {
            opacity: 1;

        }

        .chatbot-container {
            position: fixed;
            bottom: 0px;
            right: 35px;
            width: 450px;
            height: 600px;
            z-index: 1040;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            box-shadow: 0 0 128px 0 rgba(0, 0, 0, 0.1), 0 32px 64px -48px rgba(0, 0, 0, 0.5);
            transform: scale(0.5);
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s ease-in-out;
            transform-origin: bottom right;
            display: flex;
            flex-direction: column;
        }

        .show-chatbot .chatbot-container {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }

        .chatbot-container .chatbox {
            overflow-y: auto;
            height: 510px;
            padding: 25px 20px 100px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chatbox .chat {
            display: flex;
            max-width: 95%;
        }

        .chatbox .chat p {
            padding: 12px 16px;
            border-radius: 18px 18px 0 18px;
            background: var(--primary-color);
            color: white;
            font-size: 0.95rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
        }

        .chatbox .chat.incoming p {
            background: #f2f2f2;
            color: #000;
            border-radius: 18px 18px 18px 0;
        }

        .chatbox .chat .fa-robot,
        .chatbox .chat .fa-user {
            font-size: 1.2rem;
            color: white;
            background: var(--primary-color);
            height: 32px;
            width: 32px;
            text-align: center;
            line-height: 32px;
            border-radius: 4px;
            margin: 0 10px 7px 0;
            align-self: flex-end;
        }

        .chatbox .chat.incoming .fa-robot {
            color: white;
            background: var(--primary-color);
            margin: 0 10px 7px 0;
        }

        .chatbox .chat.outgoing {
            justify-content: flex-end;
            margin-left: auto;
        }

        .chatbot-container .chat-input {
            display: flex;
            gap: 5px;
            position: absolute;
            bottom: 0;
            width: 100%;
            background: #fff;
            padding: 15px 20px;
            border-top: 1px solid #ddd;
            border-radius: 0 0 15px 15px;
            box-sizing: border-box;
        }

        .chat-input textarea {
            height: 55px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 8px;
            resize: none;
            padding: 15px;
            font-size: 0.95rem;
            outline: none;
            font-family: 'Poppins', sans-serif;
            box-sizing: border-box;
        }

        .chat-input span {
            align-self: flex-end;
            height: 55px;
            width: 55px;
            background: var(--primary-color);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .chat-input span:hover {
            background: var(--primary-hover);
        }

        /* --- END OF CHATBOT STYLES --- */


        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        /* Layout: Header & Sidebar */
        header {
            position: fixed;
            top: 0;
            left: 220px;
            right: 0;
            background: linear-gradient(90deg, #27AE60, var(--primary-color));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            animation: slideDown 0.6s ease-out;
        }

        header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #fff;
        }

        .voice-assistant-btn {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.3s;
            box-shadow: 0 0 10px var(--primary-glow);
            text-transform: uppercase;
            margin-right: 15px;
        }

        .voice-assistant-btn i {
            font-size: 1rem;
        }

        .voice-assistant-btn:hover {
            background: var(--primary-color);
            color: #000;
            box-shadow: 0 0 20px var(--primary-color);
            transform: translateY(-2px);
        }

        .voice-assistant-btn.listening {
            background: #ff0055 !important;
            border-color: #fff !important;
            color: #fff !important;
            animation: pulse-red-header 1s infinite alternate;
        }

        @keyframes pulse-red-header {
            0% {
                box-shadow: 0 0 5px #ff0055;
            }

            100% {
                box-shadow: 0 0 15px #ff0055;
            }
        }

        #google_translate_element {
            margin-right: 15px;
        }

        .hamburger-menu {
            display: none;
            font-size: 1.8rem;
            cursor: pointer;
            z-index: 1003;
        }

        /* Custom Language Selector Styles */
        .custom-lang-selector {
            position: relative;
            z-index: 1002;
        }

        .lang-btn {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--primary-color);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .lang-btn:hover {
            background: var(--primary-color);
            color: black;
        }

        .lang-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            width: 300px;
            background: #111;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: fadeIn 0.3s ease-out;
        }

        .lang-dropdown.active {
            display: flex;
        }

        .lang-search {
            padding: 15px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
        }

        .lang-search input {
            width: 100%;
            padding: 8px 12px;
            background: #000;
            border: 1px solid #444;
            color: white;
            border-radius: 6px;
            outline: none;
            font-size: 0.85rem;
        }

        .lang-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }

        .lang-item {
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .lang-item:hover {
            background: var(--primary-color);
            color: black;
        }

        .lang-item.recent::after {
            content: 'Recent';
            font-size: 0.7rem;
            opacity: 0.6;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Hide Google Translate UI */
        .goog-te-banner-frame,
        .goog-te-menu-value,
        .goog-logo-link,
        #google_translate_element span,
        .goog-te-gadget,
        .goog-te-gadget-icon {
            display: none !important;
        }

        .goog-te-combo {
            background: transparent !important;
            border: 1px solid #444 !important;
            color: white !important;
            padding: 5px !important;
            border-radius: 4px !important;
        }

        iframe.goog-te-banner-frame {
            display: none !important;
        }

        body {
            top: 0 !important;
        }

        /* PROFILE STYLES START */
        .user-profile {
            position: relative;
            display: none;
            /* Initially hidden */
            align-items: center;
            cursor: pointer;
        }

        #header-profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px;
            border: 2px solid white;
        }

        #username-display {
            font-weight: 500;
            font-size: 1rem;
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: 140%;
            right: 0;
            background-color: var(--white-bg);
            color: var(--text-dark);
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            padding: 15px 20px;
            width: 250px;
            z-index: 1001;
            border-top: 3px solid var(--primary-color);
            animation: fadeInUp 0.3s ease-out;
        }

        .profile-dropdown p {
            margin: 0 0 12px 0;
            font-size: 0.95rem;
            word-wrap: break-word;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-dropdown .edit-profile-btn {
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.9rem;
            transition: color 0.2s;
            margin-left: 10px;
        }

        .profile-dropdown .edit-profile-btn:hover {
            color: var(--primary-hover);
        }

        .profile-dropdown a {
            display: block;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            transition: color 0.2s;
        }

        .profile-dropdown a:hover {
            color: var(--primary-hover);
        }

        .user-profile.active .profile-dropdown {
            display: block;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        /* PROFILE STYLES END */


        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 220px;
            height: 100%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            z-index: 1001;
            animation: slideInLeft 0.6s ease-out;
        }

        #sidebar-weather-widget {
            padding: 20px 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: #f1f5f9;
            background-color: rgba(0, 0, 0, 0.1);
            width: 100%;
            box-sizing: border-box;
        }

        #sidebar-weather-widget i {
            font-size: 2.5rem;
            margin-bottom: 8px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        #sidebar-weather-widget #weather-temp {
            font-size: 1.6rem;
            font-weight: 600;
        }

        #sidebar-weather-widget #weather-location {
            font-size: 0.9rem;
            font-weight: 400;
            opacity: 0.9;
        }

        .sidebar a {
            padding: 15px 25px;
            color: white;
            text-decoration: none;
            width: 100%;
            display: flex;
            align-items: center;
            box-sizing: border-box;
            font-weight: 500;
            position: relative;
            transition: color 0.3s ease;
        }

        .sidebar a::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0;
            background-color: var(--primary-color);
            z-index: -1;
            transition: width 0.3s ease-in-out;
        }

        .sidebar a:hover::before {
            width: 100%;
        }

        .sidebar a i {
            margin-right: 15px;
            width: 20px;
            text-align: center;
        }

        .content {
            margin-left: 220px;
            padding-top: 70px;
            width: calc(100% - 220px);
            height: calc(100vh - 70px);
            overflow-y: auto;
        }


        .container {
            display: none;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            padding: 30px;
            animation: fadeIn 0.5s ease-in-out;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative;
            width: 100%;
            min-height: 100%;
            box-sizing: border-box;
        }

        /* --- NEW --- Added styles for the prices container */
        #prices.container {
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        /* CODE MODIFICATION: Increased width of content boxes */
        #disease .box,
        #prices .box,
        #planner .box,
        #buysell .box,
        #loan .box,
        #edit-profile .box,
        #community .box {
            max-width: 600px !important;
            /* <--- This !important is crucial */
        }

        .box {
            flex-grow: 0;
            flex-shrink: 1;
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.8), inset 0 0 15px rgba(57, 255, 20, 0.1);
            border-top: 5px solid var(--primary-color);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .weather-news-section {
            margin-top: 30px;
            width: 100%;
            border-top: 1px solid var(--glass-border);
            padding-top: 25px;
        }

        .weather-news-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .weather-video-card {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
        }

        .weather-video-card iframe {
            width: 100%;
            aspect-ratio: 16/9;
            border: none;
        }

        .weather-video-info {
            padding: 15px;
        }

        .weather-video-info h4 {
            margin: 0;
            font-size: 0.95rem;
            color: var(--electric-blue);
        }

        .box:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 12px 50px rgba(57, 255, 20, 0.15);
            border-color: var(--electric-blue);
        }

        .status-chips {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            width: 100%;
            justify-content: center;
        }

        .status-chip {
            background: rgba(0, 246, 255, 0.1);
            border: 1px solid var(--electric-blue);
            padding: 5px 15px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--electric-blue);
            display: flex;
            align-items: center;
            gap: 8px;
            text-shadow: 0 0 5px var(--electric-blue);
        }

        .status-chip .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary-color);
            box-shadow: 0 0 8px var(--primary-color);
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.5);
                opacity: 0.5;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        h2,
        h3 {
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #weather .box {
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            padding: 25px;
            background: rgba(0, 0, 0, 0.85);
            /* Darker for weather details */
        }

        /* EDIT PROFILE STYLES */
        .profile-pic-uploader {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto 25px;
        }

        .profile-pic-uploader img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary-color);
        }

        .profile-pic-uploader label {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 40px;
            height: 40px;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .profile-pic-uploader label:hover {
            background-color: var(--primary-color);
        }

        .profile-pic-uploader input[type="file"] {
            display: none;
        }

        #edit-profile-form label {
            display: block;
            text-align: left;
            font-weight: 500;
            margin-top: 20px;
            margin-bottom: 8px;
        }

        #edit-profile-form input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        #edit-profile-form input:disabled {
            background-color: #f2f2f2;
            cursor: not-allowed;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .form-buttons button {
            flex: 1;
            padding: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.3s ease;
        }

        .form-buttons button.back-btn {
            background-color: #7f8c8d;
        }

        .form-buttons button.back-btn:hover {
            background-color: #95a5a6;
        }

        .form-buttons button:hover {
            background-color: var(--primary-hover);
        }

        /* END OF EDIT PROFILE STYLES */

        #disease .box label,
        #prices .box label,
        #planner .box label,
        #buysell .box label,
        #loan .box label {
            display: block;
            text-align: left;
            font-weight: 500;
            margin-top: 20px;
            margin-bottom: 8px;
        }

        #disease .box input,
        #disease .box select,
        #prices .box input,
        #prices .box select,
        #planner .box input,
        #planner .box select,
        #buysell .box input,
        #buysell .box select,
        #loan .box input,
        #loan .box textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        #loan .box textarea {
            resize: vertical;
            min-height: 100px;
        }

        #disease .box button,
        #prices .box button,
        #planner .box button,
        #buysell .box button,
        #loan .box button,
        #tutorials .box button {
            width: 100%;
            padding: 12px;
            margin-top: 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.3s ease;
        }

        #disease .box button:hover,
        #prices .box button:hover,
        #planner .box button:hover,
        #buysell .box button:hover,
        #loan .box button:hover,
        #tutorials .box button:hover {
            background-color: var(--primary-hover);
            box-shadow: 0 0 20px var(--primary-color);
            transform: scale(1.02);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
        }

        .file-input-wrapper:hover {
            border-color: var(--primary-color);
            background-color: #f9f9f9;
        }

        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }

        .file-input-wrapper .file-input-label {
            color: #555;
            font-weight: 500;
        }

        .file-input-wrapper .file-input-label i {
            display: block;
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .file-name {
            margin-top: 10px;
            font-style: italic;
            color: var(--primary-hover);
            font-weight: 500;
        }

        .loan-suggestion {
            background-color: #e8f8f5;
            border-left: 5px solid var(--primary-color);
            padding: 20px;
            margin-top: 20px;
            text-align: left;
            border-radius: 8px;
        }

        .loan-suggestion h3 {
            margin: 0 0 10px 0;
            color: var(--primary-hover);
        }

        .terms-box {
            height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            text-align: left;
            font-size: 0.9rem;
            border-radius: 8px;
            margin-top: 15px;
            background-color: #fafafa;
        }

        .terms-check {
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .popup-content {
            background: white;
            padding: 30px 40px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            animation: fadeInUp 0.5s;
        }

        .popup-content i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .popup-content p {
            font-size: 1.1rem;
            margin: 0 0 20px 0;
        }

        .popup-close-btn {
            padding: 10px 30px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            border-radius: 8px;
            cursor: pointer;
        }

        .weather-search-form,
        .tutorial-search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .weather-search-form input,
        .tutorial-search-form input {
            flex-grow: 1;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            width: 100%;
            box-sizing: border-box;
            font-size: 1rem;
        }

        #weather .box button,
        #tutorials .box button {
            width: auto;
            padding: 0 25px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 0;
            font-size: 1rem;
            font-weight: 500;
            flex-shrink: 0;
        }

        #weather .box button:hover,
        #tutorials .box button:hover {
            background-color: var(--primary-hover);
        }

        #weather .box button i,
        #tutorials .box button i {
            margin-right: 5px;
        }

        .form-divider {
            text-align: center;
            margin: 15px auto;
            font-weight: 500;
            color: #999;
            max-width: 500px;
        }

        /* --- VEGETABLE INFO DETAILS --- */
        #vegetable-info-details {
            display: none;
            width: 100%;
            max-width: 1200px;
            margin-top: 30px;
            background: rgba(0, 0, 0, 0.9) !important;
            border-radius: 16px;
            box-shadow: 0 0 30px var(--primary-glow);
            padding: 40px;
            z-index: 2;
            position: relative;
            flex-direction: row;
            gap: 40px;
            animation: fadeInUp 0.6s ease-out forwards;
            border: 1px solid var(--primary-color);
            color: #fff !important;
        }

        .veg-image-container {
            flex: 1;
            max-width: 400px;
        }

        #veg-info-image {
            width: 100%;
            height: auto;
            border-radius: 12px;
            object-fit: cover;
            border: 2px solid var(--primary-color);
        }

        .veg-details-container {
            flex: 2;
        }

        #veg-info-name {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0 0 20px 0;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .veg-info-section {
            margin-bottom: 30px;
        }

        .veg-info-section h4 {
            font-size: 1.3rem;
            margin: 0 0 15px 0;
            color: var(--electric-blue);
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 4px solid var(--primary-color);
            padding-left: 12px;
        }

        .veg-info-section p {
            font-size: 1rem;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
        }

        /* Real-time Feature Styles */
        .realtime-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 30px;
        }

        .realtime-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            padding: 20px;
            border-radius: 12px;
            transition: 0.3s;
        }

        .realtime-card:hover {
            border-color: var(--primary-color);
            background: rgba(57, 255, 20, 0.1);
        }

        .realtime-card h5 {
            color: var(--primary-color);
            font-size: 1.1rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .realtime-card .status-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: auto;
        }

        .status-up {
            background: #1b5e20;
            color: #4caf50;
        }

        .status-down {
            background: #b71c1c;
            color: #f44336;
        }

        .status-active {
            background: #01579b;
            color: #03a9f4;
        }

        .veg-info-section h4 i {
            color: var(--primary-color);
        }

        .veg-info-section p,
        .veg-info-section li {
            font-size: 0.95rem;
            line-height: 1.7;
            color: #555;
        }

        .nutrition-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .nutrition-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }

        .nutrition-table td:first-child {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* --- Mobile View Changes for the new section --- */
        @media (max-width: 920px) {
            #vegetable-info-details {
                flex-direction: column;
            }
        }

        #planner-output {
            display: none;
            background: rgba(0, 0, 0, 0.94) !important;
            border: 1px solid var(--primary-color);
            border-radius: 16px;
            padding: 40px;
            margin-top: 30px;
            box-shadow: 0 0 40px rgba(57, 255, 20, 0.15);
            color: #fff !important;
            animation: fadeInUp 0.5s ease-out;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            position: relative;
            overflow: hidden;
        }

        #planner-output::before {
            content: "STRATEGIC AGRI-PLAN";
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 0.7rem;
            letter-spacing: 2px;
            color: var(--primary-color);
            opacity: 0.5;
            font-weight: 800;
        }

        .action-btn i {
            margin-right: 8px;
        }

        /* ############################################################# */
        /* ############## NEW ATTRACTIVE WEATHER STYLES ################ */
        /* ############################################################# */

        /* ############################################################# */
        /* ############## ULTIMATE WEATHER DECK V5 STYLES ############ */
        /* ############################################################# */

        /* ############################################################# */
        /* ############## AGRO-TV 24/7 BROADCAST STYLES ############ */
        /* ############################################################# */

        .broadcast-container {
            position: relative;
            width: 100%;
            height: 500px;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            grid-column: span 6;
            margin-bottom: 25px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .broadcast-overlay-top {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
        }

        .live-tag {
            background: #ff3131;
            color: white;
            padding: 5px 15px;
            border-radius: 4px;
            font-weight: 900;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: pulse-red 1.5s infinite;
        }

        .agro-tv-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Space Mono', monospace;
            font-weight: 900;
            color: var(--primary-color);
            text-shadow: 0 0 10px var(--primary-glow);
            font-size: 1.2rem;
        }

        .broadcast-clock-digital {
            background: rgba(0, 0, 0, 0.7);
            color: #00f6ff;
            font-family: 'Space Mono', monospace;
            padding: 10px 20px;
            border-radius: 10px;
            border-left: 4px solid var(--electric-blue);
            font-size: 1.3rem;
            font-weight: 700;
        }

        .news-ticker-v5 {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background: linear-gradient(90deg, #111, #222, #111);
            border-top: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            z-index: 10;
            overflow: hidden;
        }

        .ticker-label {
            background: var(--primary-color);
            color: black;
            padding: 0 20px;
            height: 100%;
            display: flex;
            align-items: center;
            font-weight: 900;
            font-size: 0.9rem;
            white-space: nowrap;
            z-index: 11;
        }

        .ticker-content-wrapper {
            display: flex;
            white-space: nowrap;
            animation: ticker-fast 40s linear infinite;
        }

        .ticker-item {
            padding: 0 40px;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .ticker-item .temp {
            color: var(--primary-color);
            font-weight: 900;
        }

        @keyframes ticker-fast {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-50%);
            }
        }

        @keyframes pulse-red {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 49, 49, 0.7);
            }

            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(255, 49, 49, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 49, 49, 0);
            }
        }

        .breaking-banner {
            position: absolute;
            top: 100px;
            left: 0;
            background: rgba(0, 0, 0, 0.8);
            border-left: 8px solid #ff3131;
            padding: 10px 30px;
            transform: translateX(-100%);
            transition: transform 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 9;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .breaking-banner.active {
            transform: translateX(0);
        }

        .breaking-banner .label {
            color: #ff3131;
            font-weight: 900;
            font-size: 1.2rem;
            letter-spacing: 2px;
        }

        /* Virtual Studio UI */
        .virtual-studio-overlay {
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(0, 0, 0, 0.5), transparent), url('https://images.unsplash.com/photo-1592210633464-e7db0e5c4e43?w=1200&h=800&fit=crop');
            background-size: cover;
            background-position: center;
            filter: contrast(1.2) brightness(0.8);
            position: relative;
        }

        .live-weather-badges {
            position: absolute;
            bottom: 70px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 10;
        }

        .stream-badge {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            padding: 8px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 250px;
        }

        .stream-badge i {
            font-size: 1.5rem;
            width: 30px;
            text-align: center;
        }

        .stream-badge .info {
            display: flex;
            flex-direction: column;
        }

        .stream-badge .val {
            font-weight: 900;
            font-size: 1.1rem;
            color: var(--primary-color);
        }

        /* Fullscreen Launch Overlay */
        #fullscreen-launch-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #111, #000);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--primary-color);
            text-align: center;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .launch-btn {
            padding: 18px 50px;
            background: var(--primary-color);
            color: #000;
            border: none;
            border-radius: 50px;
            font-weight: 900;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 0 40px var(--primary-glow);
            margin-top: 40px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .launch-btn:hover {
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 0 60px var(--primary-glow);
        }

        .radar-scanner {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(57, 255, 20, 0.05), transparent);
            border-bottom: 2px solid var(--primary-color);
            box-shadow: 0 10px 30px rgba(57, 255, 20, 0.2);
            z-index: 2;
            animation: radar-sweep 4s linear infinite;
        }

        @keyframes radar-sweep {
            0% {
                transform: translateY(-100%);
            }

            100% {
                transform: translateY(100%);
            }
        }

        .broadcast-vignette {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, transparent 40%, rgba(0, 0, 0, 0.8) 120%);
            z-index: 3;
            pointer-events: none;
        }

        .weather-observatory {
            grid-column: span 3;
            background: linear-gradient(180deg, rgba(15, 12, 41, 0.8), rgba(48, 43, 99, 0.8), rgba(36, 36, 62, 0.8));
            border-bottom: 4px solid var(--electric-blue);
        }

        .sun-path-container {
            position: relative;
            height: 100px;
            width: 100%;
            margin-top: 15px;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.2);
        }

        .sun-curve {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 2px dashed rgba(255, 255, 0, 0.3);
            border-radius: 50% 50% 0 0 / 100% 100% 0 0;
            border-bottom: none;
        }

        .sun-icon-dynamic {
            position: absolute;
            color: #ffce00;
            filter: drop-shadow(0 0 10px #ffce00);
            font-size: 1.5rem;
            transform: translate(-50%, -50%);
        }

        .moon-phase-hero {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
        }

        .moon-icon-graphic {
            font-size: 3rem;
            color: #f5f5f5;
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.4));
        }

        /* Weather Intelligence Grid Expansion */
        .intel-chip {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .intel-chip .label {
            font-size: 0.65rem;
            opacity: 0.6;
            text-transform: uppercase;
        }

        .intel-chip .value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--electric-blue);
        }

        /* News Hub Extreme */
        .news-hub-extreme {
            grid-column: span 6;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 10px;
        }

        .news-grid-high-density {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .news-card-v5 {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 18px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .news-card-v5:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--primary-color);
            transform: translateY(-5px);
        }

        .news-card-v5 img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            filter: grayscale(0.3);
            transition: 0.3s;
        }

        .news-card-v5:hover img {
            filter: grayscale(0);
            scale: 1.05;
        }

        .news-content {
            padding: 15px;
        }

        .news-content h4 {
            font-size: 0.95rem;
            margin-bottom: 8px;
            line-height: 1.4;
            height: 2.8rem;
            overflow: hidden;
        }

        .news-content p {
            font-size: 0.75rem;
            opacity: 0.6;
            margin-bottom: 10px;
        }

        /* Alerts & Marquee */
        .weather-alert-pulse {
            grid-column: span 6;
            background: rgba(139, 0, 0, 0.2);
            border: 1px solid #ff3e3e;
            padding: 12px 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            color: #ff3e3e;
            font-weight: 700;
        }

        /* Map Layer Switcher */
        .map-layer-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        .layer-btn {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: 0.3s;
        }

        .layer-btn.active {
            background: var(--primary-color);
            color: black;
            border-color: var(--primary-color);
        }

        /* ############################################################# */
        /* ############## ADVANCED WEATHER HUB STYLES ################ */
        /* ############################################################# */

        #weather-output {
            margin-top: 25px;
            animation: fadeInUp 0.6s ease-out;
            width: 100%;
        }

        .weather-hub-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
            width: 100%;
        }

        .weather-card-premium {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid var(--glass-border);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6);
        }

        .weather-card-premium::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(57, 255, 20, 0.05) 0%, transparent 70%);
            pointer-events: none;
            transition: transform 0.6s ease;
        }

        .weather-card-premium:hover::before {
            transform: translate(10%, 10%);
        }

        .weather-card-premium:hover {
            transform: translateY(-8px) scale(1.01);
            border-color: var(--primary-color);
            box-shadow: 0 20px 50px rgba(57, 255, 20, 0.25);
        }

        /* Hero Card: Current Weather */
        .weather-hero {
            grid-column: span 2;
            background: linear-gradient(135deg, rgba(57, 255, 20, 0.15), rgba(0, 246, 255, 0.1));
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .weather-hero .header-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .weather-hero .city-clock {
            text-align: left;
        }

        .weather-hero h2 {
            font-size: 2.4rem;
            margin: 0;
            color: var(--primary-color);
            text-shadow: 0 0 20px var(--primary-glow);
            letter-spacing: -1px;
        }

        .weather-hero .live-clock {
            font-family: 'Space Mono', monospace;
            font-size: 1.2rem;
            color: var(--electric-blue);
            font-weight: 700;
            background: rgba(0, 246, 255, 0.1);
            padding: 2px 8px;
            border-radius: 5px;
            display: inline-block;
            margin-top: 5px;
        }

        .weather-hero .temp-main {
            font-size: 6rem;
            font-weight: 700;
            margin: 10px 0;
            line-height: 1;
            background: linear-gradient(to bottom, #fff, #888);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.2));
        }

        /* Windy Map Integration */
        .weather-map {
            grid-column: span 4;
            padding: 0;
            height: 450px;
            min-height: 450px;
            border: 2px solid var(--glass-border);
        }

        #windy-iframe {
            width: 100%;
            height: 100%;
            border-radius: 20px;
            border: none;
        }

        /* Gauge Visuals */
        .aqi-gauge-container {
            width: 100%;
            height: 120px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .aqi-meter {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 8px solid rgba(255, 255, 255, 0.05);
            border-top: 8px solid var(--primary-color);
            transform: rotate(-45deg);
            position: relative;
        }

        .aqi-meter-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
        }

        /* Small Detail Cards */
        .weather-detail-mini {
            grid-column: span 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.02);
        }

        .weather-detail-mini i {
            font-size: 2.2rem;
            color: var(--primary-color);
            filter: drop-shadow(0 0 8px var(--primary-glow));
        }

        .weather-detail-mini .label {
            font-size: 0.75rem;
            opacity: 0.6;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .weather-detail-mini .value {
            font-size: 1.4rem;
            font-weight: 700;
        }

        /* AI Insights Card */
        .weather-ai-insights {
            grid-column: span 3;
            border-left: 6px solid var(--cyber-purple);
            background: linear-gradient(90deg, rgba(188, 19, 254, 0.05), transparent);
        }

        .weather-ai-insights h3 {
            color: var(--cyber-purple);
            font-size: 1.4rem;
            margin-bottom: 20px;
        }

        .ai-content div {
            margin-bottom: 15px;
            font-size: 1rem;
            line-height: 1.5;
            padding-left: 10px;
            border-left: 2px solid rgba(255, 255, 255, 0.1);
        }

        /* Forecast Cards */
        .weather-forecast-scroll {
            grid-column: span 3;
        }

        .scroll-container-grid {
            display: grid;
            grid-template-rows: repeat(2, 1fr);
            grid-auto-flow: column;
            gap: 12px;
            overflow-x: auto;
            padding: 10px 0;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) transparent;
            width: 100%;
        }

        .scroll-container-grid .forecast-item {
            min-width: 110px;
            margin-right: 5px;
        }

        .scroll-container-grid::-webkit-scrollbar {
            height: 5px;
        }

        .scroll-container-grid::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }

        .forecast-item {
            min-width: 90px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .forecast-item:hover {
            background: rgba(57, 255, 20, 0.1);
            transform: translateY(-5px);
        }

        /* Knowledge & News Hub (Refined) */
        .weather-knowledge-hub {
            grid-column: span 4;
            background: linear-gradient(180deg, rgba(20, 20, 20, 0.4), rgba(10, 10, 10, 0.8));
        }

        .knowledge-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .knowledge-item {
            display: flex;
            gap: 15px;
            background: rgba(255, 255, 255, 0.02);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
            position: relative;
        }

        .knowledge-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--electric-blue);
        }

        .knowledge-item img {
            width: 100px;
            height: 100px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }

        .knowledge-info h4 {
            font-size: 1rem;
            margin: 0 0 8px 0;
            color: var(--electric-blue);
        }

        /* Risk Meter Section */
        .weather-night-analytics {
            grid-column: span 2;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(20, 30, 48, 0.7));
            border-right: 4px solid var(--electric-blue);
        }

        .risk-gauge {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .risk-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71, #f1c40f, #e74c3c);
            width: 0%;
            transition: width 1s ease-in-out;
        }

        /* Mobile Adjustments */
        @media (max-width: 1100px) {
            .weather-hub-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .weather-hero,
            .weather-map,
            .weather-ai-insights,
            .weather-forecast-scroll,
            .weather-knowledge-hub {
                grid-column: span 4;
            }
        }

        @media (max-width: 768px) {
            .weather-hub-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .weather-hero,
            .weather-map,
            .weather-ai-insights,
            .weather-forecast-scroll,
            .weather-night-analytics,
            .weather-knowledge-hub {
                grid-column: span 2;
            }

            .knowledge-grid {
                grid-template-columns: 1fr;
            }
        }


        /* ############################################################# */
        /* ####### NEW: ATTRACTIVE DISEASE RESULT STYLES START HERE ###### */
        /* ############################################################# */

        .result-box {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px dashed #ddd;
            border-radius: 8px;
            min-height: 50px;
            text-align: left;
        }

        #disease-result {
            background-color: transparent;
            border: none;
            padding: 0;
        }

        .report-section {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
            border-left: 5px solid;
        }

        .report-section h3 {
            margin: 0 0 15px 0;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .report-section h3 i {
            font-size: 1.5rem;
        }

        .report-section ul {
            list-style: none;
            padding-left: 5px;
        }

        .report-section ul li {
            position: relative;
            padding-left: 25px;
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .report-section ul li::before {
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            content: '\f058';
            /* Check circle */
            position: absolute;
            left: 0;
            top: 4px;
            color: var(--primary-color);
        }

        /* Custom styles for each section */
        .report-disease {
            border-color: #e74c3c;
        }

        /* Red for disease */
        .report-disease h3 {
            color: #e74c3c;
        }

        .report-disease ul li::before {
            content: '\f05a';
            color: #e74c3c;
        }

        /* Info circle */

        .report-healthy {
            border-color: #27ae60;
        }

        /* Green for healthy */
        .report-healthy h3 {
            color: #27ae60;
        }

        .report-healthy ul li::before {
            content: '\f058';
            color: #27ae60;
        }

        /* Check circle */

        .report-soil {
            border-color: #8D6E63;
        }

        /* Brown for soil */
        .report-soil h3 {
            color: #8D6E63;
        }

        .report-soil p {
            margin: 5px 0;
        }

        .report-water {
            border-color: #3498db;
        }

        /* Blue for water */
        .report-water h3 {
            color: #3498db;
        }

        .report-fertilizer {
            border-color: #f39c12;
        }

        /* Orange for fertilizer */
        .report-fertilizer h3 {
            color: #f39c12;
        }

        .report-pest {
            border-color: #9b59b6;
        }

        /* Purple for pests */
        .report-pest h3 {
            color: #9b59b6;
        }

        .report-spacing {
            border-color: #34495e;
        }

        /* Dark blue for spacing */
        .report-spacing h3 {
            color: #34495e;
        }


        .speak-btn {
            background: var(--primary-color);
            color: #0f172a;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px auto 20px;
            transition: transform 0.2s, background 0.2s;
        }

        .speak-btn:hover {
            transform: scale(1.05);
            background: var(--primary-hover);
        }

        .report-section {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        /* ############################################################# */
        /* ######## ATTRACTIVE DISEASE RESULT STYLES END HERE ######## */
        /* ############################################################# */

        /* Background Overlay Styles */
        #login::before,
        #disease::before,
        #weather::before,
        #prices::before,
        #planner::before,
        #buysell::before,
        #about::before,
        #news::before,
        #loan::before,
        #tutorials::before,
        #community::before,
        #edit-profile::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(15, 23, 42, 0.7);
            /* Darker overlay for Dark Mode */
            z-index: 1;
        }

        .box,
        .login-page-container,
        #buysell-choice-wrapper,
        .about-wrapper,
        .news-grid,
        .tutorials-grid,
        #vegetable-info-details {
            position: relative;
            z-index: 2;
        }

        /* Background Images */
        #about {
            background-image: url('https://images.unsplash.com/photo-1596019285084-7a3897a2253a?auto=format&fit=crop&q=80&w=2070&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
        }

        #news {
            background-image: url('https://i.pinimg.com/736x/ea/40/7a/ea407a7b30b2ea41950ba7e8fb5c0978.jpg');
        }

        #disease {
            background-image: url('https://i.pinimg.com/1200x/60/bd/fc/60bdfc7c58455210f379fcdbc350a583.jpg');
        }

        #weather {
            background-image: url('https://i.pinimg.com/1200x/61/7e/1e/617e1e21d1a19ef2e68b3ade28230731.jpg');
        }

        #prices {
            background-image: url('https://images.pexels.com/photos/2252584/pexels-photo-2252584.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1');
        }

        #planner {
            background-image: url('https://images.pexels.com/photos/440731/pexels-photo-440731.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1');
        }

        #buysell {
            background-image: url('https://i.pinimg.com/1200x/b3/e9/5d/b3e95dc21cbb6d5d0e77e796dfe0fedd.jpg');
        }

        #loan {
            background-image: url('https://www.vecteezy.com/photo/2883744-hand-holding-growing-tree-on-coins-with-stock-graph-over-green-background');
        }

        #tutorials {
            background-image: url('https://images.pexels.com/photos/265076/pexels-photo-265076.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1');
        }

        #community {
            background-image: url('https://images.pexels.com/photos/6646917/pexels-photo-6646917.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1');
        }

        #edit-profile {
            background-image: url('https://i.pinimg.com/564x/24/22/a1/2422a168a25a17a027376a911a3b1f5d.jpg');
        }


        .box {
            flex-grow: 0;
            flex-shrink: 1;
            background-color: var(--white-bg);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-top: 5px solid var(--primary-color);
        }

        .box h2 {
            font-size: 1.5rem;
            margin: 0 0 25px 0;
            color: var(--text-dark);
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 0;
        }

        .box h2 i {
            font-size: 1.5rem;
            color: var(--primary-color);
            background-color: rgba(22, 160, 133, 0.1);
            padding: 10px;
            border-radius: 50%;
            margin-right: 15px;
            transition: transform 0.3s ease;
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .box:hover h2 i {
            transform: rotate(-10deg) scale(1.1);
        }

        .coming-soon-placeholder {
            text-align: center;
            padding: 50px 20px;
            background-color: #ffffff;
            border-radius: 8px;
            border: 1px dashed #ced4da;
            color: #495057;
            width: 90%;
            margin: 0 auto;
        }

        .coming-soon-placeholder i {
            font-size: 48px;
            color: #28a745;
            /* A nice green color */
            margin-bottom: 20px;
        }

        .coming-soon-placeholder h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .coming-soon-placeholder p {
            font-size: 16px;
            max-width: 400px;
            margin: 0 auto;
        }

        #dashboard.container {
            padding: 0;
            margin: 0;
            width: 100%;
            max-width: none;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .slider-wrapper {
            display: flex;
            height: 100%;
            width: 500%;
            transition: transform 0.8s cubic-bezier(0.77, 0, 0.175, 1);
        }

        .slide {
            width: 20%;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            padding: 2rem;
            box-sizing: border-box;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .slide::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.6));
            z-index: 2;
        }

        .slide-content {
            position: relative;
            z-index: 3;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 1s 0.5s ease-out forwards;
        }

        .slide i {
            font-size: 4rem;
            margin-bottom: 1rem;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .slide h2 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            border: none;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .slide p {
            font-size: 1.2rem;
            margin-top: 0.5rem;
            max-width: 500px;
        }

        .slider-nav {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 3;
        }

        .slider-nav-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .slider-nav-dot.active {
            background-color: white;
        }

        .slide-background-gif {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        #about.container {
            align-items: center;
            flex-direction: column;
            justify-content: flex-start;
        }

        .about-wrapper {
            max-width: 900px;
            width: 100%;
            background: var(--glass-bg);
            padding: 50px 50px 0 50px;
            /* Remove bottom padding */
            border-radius: 20px;
            border-top: 5px solid var(--primary-color);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            animation: slideInFromTop 0.8s ease-out forwards;
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }

        .about-wrapper h2 {
            text-align: center;
            font-size: 2.2rem;
            margin-bottom: 25px;
            color: var(--text-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            border: none;
        }

        .about-wrapper p {
            line-height: 1.8;
            color: #444;
            text-align: justify;
            font-size: 1.05rem;
        }

        .stats-counter {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            text-align: center;
            margin: 40px 0;
            padding: 20px;
        }

        .stat {
            background: rgba(255, 255, 255, 0.7);
            padding: 25px 15px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-bottom: 3px solid var(--primary-color);
        }

        .stat:hover {
            transform: translateY(-10px);
            box-shadow: 0 12px 25px rgba(22, 160, 133, 0.2);
        }

        .stat i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .stat h3 {
            margin: 0;
            font-size: 2.8rem;
            color: var(--primary-hover);
            font-weight: 700;
        }

        .stat p {
            margin: 5px 0 0 0;
            color: var(--text-dark);
            font-weight: 500;
            font-size: 1rem;
        }

        .team-section {
            margin-top: 40px;
        }

        .team-section h2 {
            text-align: center;
            font-size: 2rem;
            border-bottom: 3px solid var(--primary-color);
            color: var(--text-dark);
            display: inline-block;
            padding-bottom: 10px;
            margin-bottom: 40px;
            font-weight: 600;
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 30px;
        }

        .team-card {
            position: relative;
            background: #fff;
            border-radius: 15px;
            text-align: center;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            overflow: hidden;
        }

        .team-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .team-card img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid var(--primary-color);
            transition: transform 0.4s ease;
            margin-bottom: 15px;
        }

        .team-card:hover img {
            transform: scale(1.1) rotate(5deg);
        }

        .team-card h4 {
            margin: 15px 0 5px 0;
            font-size: 1.25rem;
        }

        .team-card p {
            margin: 0;
            color: #777;
            font-style: italic;
        }

        .team-card-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #28a746c0;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transform: translateY(100%);
            transition: all 0.4s ease-in-out;
        }

        .team-card:hover .team-card-overlay {
            opacity: 1;
            transform: translateY(0);
        }

        .portfolio-btn {
            padding: 10px 25px;
            background-color: var(--white-bg);
            color: var(--primary-hover);
            font-weight: 600;
            text-decoration: none;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        .portfolio-btn:hover {
            transform: scale(1.1);
        }

        .happy-users-section {
            margin-top: 40px;
            padding-top: 40px;
            border-top: 1px solid #eee;
            text-align: center;
        }

        .happy-users-section h2 {
            text-align: center;
            font-size: 2rem;
            border-bottom: 3px solid var(--primary-color);
            color: var(--text-dark);
            display: inline-block;
            padding-bottom: 10px;
            margin-bottom: 40px;
            font-weight: 600;
        }

        .happy-users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
        }

        .user-card {
            background: #fff;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            text-align: center;
        }

        .user-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .user-card img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary-color);
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .user-card img:hover {
            transform: scale(1.05);
        }

        .user-card .testimonial-quote {
            font-style: italic;
            color: #555;
            margin-bottom: 15px;
            position: relative;
            padding: 0 10px;
        }

        .user-card .testimonial-quote::before {
            content: 'â€œ';
            position: absolute;
            top: -10px;
            left: 0;
            font-size: 2.5rem;
            color: var(--primary-color);
            opacity: 0.5;
        }

        .user-card .user-name {
            font-weight: 600;
            color: var(--text-dark);
        }

        /* --- NEW ATTRACTIVE FOOTER STYLES --- */
        .about-footer {
            width: 100%;
            background-color: transparent;
            /* Make it transparent to blend with wrapper */
            animation: fadeInUp 1s ease-out;
            margin-top: 40px;
            /* Space from content above */
            padding-top: 30px;
            /* Space from content above */
            border-top: 1px solid #eee;
            /* Separator line */
        }

        .footer-main {
            padding: 0 0 40px 0;
            /* Adjust padding */
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 30px;
        }

        .footer-col {
            flex: 1;
            min-width: 220px;
        }

        .footer-col h4 {
            color: var(--text-dark);
            margin: 0 0 15px 0;
            font-weight: 600;
            position: relative;
            padding-bottom: 10px;
        }

        .footer-col h4::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 3px;
            background-color: var(--primary-color);
        }

        /* Branding Column */
        .footer-branding .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .footer-branding .logo-icon {
            font-size: 2.5rem;
            color: white;
            background: var(--primary-color);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .footer-branding h3 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-dark);
        }

        .footer-branding p {
            font-size: 0.95rem;
            color: #555;
            line-height: 1.6;
        }

        .footer-socials a {
            color: var(--secondary-color);
            font-size: 1.2rem;
            margin-right: 15px;
            transition: color 0.3s ease;
        }

        .footer-socials a:hover {
            color: var(--primary-color);
        }

        .footer-motivation {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e9e9e9;
            /* Light separator line */
        }

        .footer-motivation h4 {
            color: var(--text-dark);
            margin-bottom: 10px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .footer-motivation h4 i {
            color: var(--primary-color);
            margin-right: 8px;
        }

        .footer-motivation p {
            margin: 5px 0;
            color: #555;
            font-size: 0.95rem;
        }

        /* Quick Links Column */
        .footer-links ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .footer-links li a {
            color: #555;
            text-decoration: none;
            display: block;
            padding: 5px 0;
            transition: color 0.3s, transform 0.3s;
        }

        .footer-links li a:hover {
            color: var(--primary-color);
            transform: translateX(5px);
        }

        /* Contact Info Column */
        .footer-contact p {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin: 0 0 15px 0;
            color: #555;
        }

        .footer-contact i {
            color: var(--primary-color);
            margin-top: 4px;
        }

        .footer-copyright {
            background-color: var(--secondary-color);
            color: var(--light-bg);
            text-align: center;
            padding: 15px;
            font-size: 0.9rem;
            margin: 0 -50px;
            /* Stretch to edges of wrapper padding */
            border-radius: 0 0 20px 20px;
            /* Match wrapper radius */
        }

        .news-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            width: 100%;
            padding: 10px;
        }

        .news-card {
            background: var(--white-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s, box-shadow 0.3s;
            text-decoration: none;
            color: inherit;
        }

        .news-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
        }

        .news-card-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .news-card-content {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .news-card-content h3 {
            font-size: 1.2rem;
            margin: 0 0 10px 0;
            color: var(--text-dark);
        }

        .news-card-content p {
            font-size: 0.9rem;
            color: #555;
            line-height: 1.6;
            margin: 0 0 15px 0;
            flex-grow: 1;
        }

        .news-card-footer {
            font-size: 0.8rem;
            color: #888;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        #news-loader {
            color: white;
            font-size: 1.5rem;
            text-align: center;
            z-index: 5;
            position: relative;
        }


        /* --- IMAGE MODAL STYLES --- */
        #image-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 11000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        #image-modal-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            animation: zoomIn 0.4s ease-out;
        }

        #image-modal-content img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #image-modal-close {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 40px;
            height: 40px;
            background-color: white;
            color: var(--text-dark);
            font-size: 28px;
            font-weight: bold;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            line-height: 1;
            transition: transform 0.2s ease;
        }

        #image-modal-close:hover {
            transform: scale(1.1) rotate(90deg);
        }


        #login.container {
            padding: 0;
            align-items: center;
            justify-content: center;
        }

        .login-page-container {
            background-color: var(--white-bg);
            border-radius: 10px;
            box-shadow: 0 14px 28px rgba(0, 0, 0, 0.25), 0 10px 10px rgba(0, 0, 0, 0.22);
            position: relative;
            overflow: hidden;
            width: 768px;
            max-width: 100%;
            min-height: 520px;
            animation: fadeInUp 0.8s ease-out;
        }

        .form-container {
            position: absolute;
            top: 0;
            height: 100%;
            transition: all 0.6s ease-in-out;
        }

        .sign-in-container {
            left: 0;
            width: 50%;
            z-index: 2;
        }

        .sign-up-container {
            left: 0;
            width: 50%;
            z-index: 1;
            opacity: 0;
        }

        .login-page-container form {
            background-color: var(--white-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 0 50px;
            height: 100%;
            text-align: center;
        }

        .login-page-container h1 {
            font-weight: bold;
            margin: 0 0 15px 0;
            color: var(--text-dark);
        }

        .login-page-container p {
            font-size: 14px;
            font-weight: 100;
            line-height: 20px;
            letter-spacing: 0.5px;
            margin: 20px 0 30px;
        }

        .login-page-container input {
            background-color: #eee;
            border: none;
            padding: 12px 15px;
            margin: 8px 0;
            width: 100%;
            border-radius: 8px;
            box-sizing: border-box;
        }

        .login-page-container button {
            border-radius: 20px;
            border: 1px solid var(--primary-color);
            background-color: var(--primary-color);
            color: #FFFFFF;
            font-size: 12px;
            font-weight: bold;
            padding: 12px 45px;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: transform 80ms ease-in, background-color 0.3s;
            cursor: pointer;
            margin-top: 10px;
        }

        .login-page-container button:hover {
            background-color: var(--primary-hover);
        }

        .login-page-container button:active {
            transform: scale(0.95);
        }

        .login-page-container button:focus {
            outline: none;
        }

        .login-page-container button.ghost {
            background-color: transparent;
            border-color: #FFFFFF;
        }

        .overlay-container {
            position: absolute;
            top: 0;
            left: 50%;
            width: 50%;
            height: 100%;
            overflow: hidden;
            transition: transform 0.6s ease-in-out;
            z-index: 100;
        }

        .overlay {
            background: var(--primary-color);
            background: linear-gradient(to right, var(--primary-hover), var(--primary-color));
            background-repeat: no-repeat;
            background-size: cover;
            background-position: 0 0;
            color: #FFFFFF;
            position: relative;
            left: -100%;
            height: 100%;
            width: 200%;
            transform: translateX(0);
            transition: transform 0.6s ease-in-out;
        }

        .overlay-panel {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 0 40px;
            text-align: center;
            top: 0;
            height: 100%;
            width: 50%;
            transform: translateX(0);
            transition: transform 0.6s ease-in-out;
        }

        .overlay-left {
            transform: translateX(-20%);
        }

        .overlay-right {
            right: 0;
            transform: translateX(0);
        }

        .login-page-container.right-panel-active .sign-in-container {
            transform: translateX(100%);
        }

        .login-page-container.right-panel-active .overlay-container {
            transform: translateX(-100%);
        }

        .login-page-container.right-panel-active .sign-up-container {
            transform: translateX(100%);
            opacity: 1;
            z-index: 5;
            animation: show 0.6s;
        }

        @keyframes show {

            0%,
            49.99% {
                opacity: 0;
                z-index: 1;
            }

            50%,
            100% {
                opacity: 1;
                z-index: 5;
            }
        }

        .login-page-container.right-panel-active .overlay {
            transform: translateX(50%);
        }

        .login-page-container.right-panel-active .overlay-left {
            transform: translateX(0);
        }

        .login-page-container.right-panel-active .overlay-right {
            transform: translateX(20%);
        }


        #buysell-choice-wrapper {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 40px;
            width: 100%;
            max-width: 800px;
        }

        .choice-card {
            background-color: var(--white-bg);
            border-radius: 20px;
            padding: 40px 30px;
            width: 280px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.09);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 2px solid transparent;
            opacity: 0;
            animation: fadeInUp 0.5s ease-out forwards;
        }

        .choice-card:nth-child(2) {
            animation-delay: 0.2s;
        }

        .choice-card:hover {
            transform: translateY(-12px);
            box-shadow: 0 12px 25px rgba(22, 160, 133, 0.2);
            border-color: var(--primary-color);
        }

        .choice-card:active {
            transform: translateY(-5px);
        }

        .choice-card i {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .choice-card h3 {
            font-size: 1.8rem;
            color: var(--text-dark);
            margin: 0 0 10px 0;
        }

        .choice-card p {
            font-size: 1rem;
            color: #555555;
            margin: 0;
            line-height: 1.5;
        }

        /* --- NEW TUTORIALS SECTION STYLES --- */
        .tutorials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            width: 100%;
            margin-top: 20px;
        }

        .tutorial-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .tutorial-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
        }

        .tutorial-card-thumbnail {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
            /* 16:9 Aspect Ratio */
        }

        .tutorial-card-thumbnail img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }

        .tutorial-card-content {
            padding: 15px;
        }

        .tutorial-card-content h4 {
            margin: 0 0 10px 0;
            font-size: 1.1rem;
            line-height: 1.4;
        }

        .tutorial-card-content p {
            margin: 0;
            font-size: 0.9rem;
            color: #666;
        }

        #tutorials-output {
            width: 100%;
        }

        @media (max-width: 920px) {

            /* Adjust breakpoint for footer */
            .footer-main {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .footer-col {
                min-width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .footer-col h4::after {
                left: 50%;
                transform: translateX(-50%);
            }

            /* --- NEW --- Mobile styles for vegetable info */
            #vegetable-info-details {
                flex-direction: column;
            }
        }

        /* Add this CSS for better link styles in the footer */
        .footer-contact a,
        .footer-motivation a {
            color: inherit;
            /* Keeps the text color the same */
            text-decoration: none;
            /* Removes the underline */
            transition: color 0.3s;
        }

        .footer-contact a:hover,
        .footer-motivation a:hover {
            color: var(--primary-color);
            /* Changes color on hover */
            text-decoration: underline;
            /* Adds underline on hover */
        }

        /* ############################################################# */
        /* ############# MOBILE VIEW STYLES (768px and below) ############ */
        /* ############################################################# */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
                overflow: auto;
                /* Allow body to scroll */
                height: 100%;
            }

            /* --- MOBILE HEADER & NAVIGATION --- */
            header {
                position: fixed;
                /* Keep header at top */
                left: 0;
                width: 100%;
                animation: none;
                box-sizing: border-box;
                z-index: 1002;
                /* Above content */
            }

            .hamburger-menu {
                display: block;
                /* Show hamburger on mobile */
            }

            .sidebar {
                /* Transform sidebar into a full-screen mobile menu */
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100vh;
                background-color: var(--secondary-color);
                z-index: 1001;
                /* Below header but above content */
                transform: translateX(-100%);
                /* Hide it off-screen */
                transition: transform 0.4s ease-in-out;
                flex-direction: column;
                justify-content: center;
                /* Center links vertically */
                align-items: center;
                padding-top: 0;
                animation: none;
                overflow-y: auto;
            }

            body.mobile-nav-open .sidebar {
                transform: translateX(0);
                /* Show the menu */
            }

            .sidebar a {
                padding: 20px 25px;
                font-size: 1.5rem;
                /* Bigger font for mobile */
                width: 80%;
                justify-content: center;
                text-align: center;
            }

            .sidebar a i {
                margin-right: 15px;
            }

            .sidebar a span {
                display: inline;
            }

            /* Ensure text is visible */

            #sidebar-weather-widget {
                display: none !important;
            }

            /* --- MOBILE CONTENT & LAYOUT --- */
            .content {
                margin-left: 0;
                padding-top: 70px;
                /* Space for the fixed header */
                width: 100%;
                height: auto;
                /* Allow content to define its own height */
                min-height: calc(100vh - 70px);
                overflow-y: visible;
            }

            .container {
                width: 100%;
                min-height: calc(100vh - 70px);
                /* Fill the screen height */
                padding: 20px;
                box-sizing: border-box;
                background-attachment: scroll;
                /* Better for mobile */
                justify-content: flex-start;
                /* Align content to the top */
                align-items: flex-start;
            }

            /* HIDE DESKTOP DASHBOARD on mobile */
            #dashboard {
                display: none !important;
            }

            .box,
            .about-wrapper {
                padding: 25px;
                width: 100%;
                box-sizing: border-box;
            }

            /* --- MOBILE SPECIFIC SECTION STYLING --- */
            .stats-counter,
            .happy-users-grid,
            .team-grid {
                grid-template-columns: 1fr;
            }

            .about-wrapper {
                padding: 25px 25px 0 25px;
                border-radius: 0;
                min-height: calc(100vh - 70px);
            }

            .about-footer {
                padding-top: 20px;
            }

            .footer-copyright {
                margin: 0 -25px;
                border-radius: 0;
            }

            #buysell.container {
                justify-content: center;
            }

            .choice-card {
                width: 100%;
                max-width: 300px;
            }

            /* --- MOBILE LOGIN PAGE --- */
            #login.container {
                padding: 0;
                height: calc(100vh - 70px);
                overflow-y: auto;
            }

            .login-page-container {
                width: 100%;
                min-height: calc(100vh - 70px);
                height: 100%;
                border-radius: 0;
                box-shadow: none;
                display: flex;
                flex-direction: column;
            }

            .overlay-container {
                display: none;
            }

            /* Hide the side panel */

            .form-container {
                position: relative;
                width: 100%;
                height: auto;
                min-height: 200px;
                /* Ensure it has some height */
                padding: 0 25px;
                box-sizing: border-box;
                opacity: 1;
                z-index: 2;
            }

            .login-page-container form {
                padding: 20px 20px;
            }

            .sign-in-container {
                display: none;
                /* Controlled by JS */
            }

            .sign-up-container {
                display: none;
                /* Controlled by JS */
            }

            .login-page-container .mobile-toggle-forms {
                display: block;
                text-align: center;
                padding: 20px;
                z-index: 5;
                position: relative;
                background: #f7f7f7;
                border-top: 1px solid #eee;
            }

            .login-page-container .mobile-toggle-forms button {
                background-color: transparent;
                border: none;
                color: var(--primary-color);
                font-weight: bold;
                text-decoration: underline;
                cursor: pointer;
            }

            /* --- MOBILE CHATBOT --- */
            .chatbot-container {
                right: 0;
                bottom: 0;
                width: 100%;
                height: 100%;
                border-radius: 0;
                transform: translateX(100%);
                transition: transform 0.3s ease-in-out;
                z-index: 10000;
            }

            .show-chatbot .chatbot-container {
                transform: translateX(0%);
            }

            .chatbot-container .chatbox {
                height: calc(100% - 150px);
            }

            .chatbot-toggler {
                bottom: 20px;
                right: 20px;
                z-index: 10001;
                /* Above the chatbot itself */
            }

            /* Mobile specific styles for voice assistant button in header */
            .header-right .voice-assistant-btn {
                position: static;
                /* Remove fixed positioning */
                bottom: auto;
                right: auto;
                margin-right: 10px;
                /* Add some spacing */
                padding: 8px 12px;
                /* Reduce size */
                font-size: 0.9em;
            }

            .header-right .voice-assistant-btn span {
                display: none;
                /* Hide text by default on mobile */
            }
        }

        /* Desktop/Tablet styles for voice assistant button */
        @media (min-width: 768px) {
            .header-right .voice-assistant-btn span {
                display: inline;
                /* Show text on larger screens */
            }
        }

        /* --- CROP GUIDE ENHANCEMENTS --- */
        .disease-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .camera-wrapper {
            position: relative;
            width: 100%;
            max-width: 700px;
            aspect-ratio: 16/9;
            margin: 20px auto;
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            overflow: hidden;
            display: none;
            background: #000;
        }

        #camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-btns {
            position: absolute;
            bottom: 15px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 10px;
            z-index: 5;
        }

        .camera-btns button {
            padding: 8px 15px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .capture-btn {
            background: var(--primary-color);
            color: #000;
        }

        .stop-cam-btn {
            background: #ff3e3e;
            color: #fff;
        }

        .report-header {
            background: linear-gradient(135deg, #1b5e20, #2e7d32);
            color: white;
            padding: 15px;
            border-radius: 12px 12px 0 0;
            text-align: center;
            border-bottom: 3px solid #ffd700;
        }

        .report-scrollable {
            max-height: 500px;
            overflow-y: auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 0 0 12px 12px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) transparent;
        }

        .report-section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-left: 4px solid var(--primary-color);
            border-radius: 4px;
        }

        .report-section h3 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
        }

        .report-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
        }

        .action-btn {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .action-btn:hover {
            background: var(--primary-color);
            color: #000;
        }

        .action-btn.active {
            background: var(--primary-color);
            color: #000;
        }

        .follow-up-container {
            margin-top: 20px;
            display: none;
            flex-direction: column;
            gap: 10px;
        }

        .follow-up-chat {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .follow-up-input-group {
            display: flex;
            gap: 10px;
        }

        .follow-up-input-group input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 10px;
            border-radius: 8px;
        }

        .follow-up-input-group button {
            background: var(--primary-color);
            border: none;
            color: #000;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* --- CROP DISEASE ENHANCEMENTS --- */
        .disease-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 25px 0;
            width: 100%;
        }

        .disease-controls .action-btn,
        .disease-controls .file-input-wrapper {
            background: var(--primary-color) !important;
            color: #000 !important;
            height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            border: none;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 4px 15px var(--primary-glow);
            font-size: 1.1rem;
            font-weight: 700;
            gap: 10px;
            padding: 0;
            margin: 0;
            width: 100%;
        }

        .disease-controls .action-btn i,
        .disease-controls .file-input-wrapper .file-input-label i {
            font-size: 2.5rem;
            margin-bottom: 0px !important;
            color: #000 !important;
        }

        .disease-controls .file-input-wrapper {
            position: relative;
            padding: 0;
        }

        .disease-controls .file-input-wrapper .file-input-label {
            color: #000 !important;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .disease-controls .file-input-wrapper:hover,
        .disease-controls .action-btn:hover {
            transform: translateY(-5px);
            background: var(--primary-hover) !important;
            box-shadow: 0 8px 25px var(--primary-glow);
        }

        @media (max-width: 768px) {
            .disease-controls {
                grid-template-columns: 1fr;
            }
        }

        /* --- AI PLANNER ENHANCEMENTS --- */
        .planner-result-box {
            background: rgba(0, 0, 0, 0.8) !important;
            border: 2px solid var(--primary-color) !important;
            color: #fff !important;
            padding: 25px !important;
            border-radius: 12px;
            box-shadow: 0 0 20px var(--primary-glow);
            margin-top: 30px;
        }

        .planner-result-box h3,
        .planner-result-box h4 {
            color: var(--primary-color) !important;
            margin-bottom: 15px;
        }

        .planner-result-box strong {
            color: var(--electric-blue);
        }

        .planner-news-section {
            margin-top: 40px;
            border-top: 1px solid var(--glass-border);
            padding-top: 30px;
        }

        .planner-news-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .planner-news-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: 0.3s;
        }

        .planner-news-card:hover {
            background: rgba(57, 255, 20, 0.1);
            transform: translateY(-5px);
            border-color: var(--primary-color);
        }

        .planner-news-card i {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .planner-news-card h4 {
            margin-bottom: 10px;
            color: white;
        }

        .planner-news-card p {
            font-size: 0.85rem;
            opacity: 0.8;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .planner-news-grid {
                grid-template-columns: 1fr;
            }
        }

        .priority-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.1);
            margin: 10px 0;
            border: 1px solid var(--glass-border);
        }

        .action-block {
            background: linear-gradient(135deg, rgba(57, 255, 20, 0.1), rgba(0, 0, 0, 0.4));
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 0 15px var(--primary-glow);
        }

        .action-item {
            margin-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 8px;
        }

        .action-item:last-child {
            border-bottom: none;
        }

        .action-label {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            display: block;
        }

        .action-value {
            font-size: 1.1rem;
            font-weight: 500;
            color: white;
        }

        .history-container {
            margin-top: 30px;
            width: 100%;
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .history-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .history-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
            box-shadow: 0 5px 15px var(--primary-glow);
        }

        .history-img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            filter: brightness(0.8);
        }

        .history-info {
            padding: 10px;
            font-size: 0.8rem;
        }

        .history-crop {
            font-weight: 700;
            color: var(--primary-color);
            display: block;
        }

        .history-status {
            opacity: 0.8;
            display: block;
        }

        .history-date {
            font-size: 0.7rem;
            opacity: 0.5;
            margin-top: 5px;
            display: block;
        }

        .brief-mode-active #disease-result .report-section:not(.action-block) {
            display: none;
        }

        .report-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 3px solid var(--primary-color);
        }

        #disease-result h3 {
            color: var(--primary-color);
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 5px;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .medicine-name {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            color: var(--electric-blue);
            font-weight: 600;
        }
    </style>
</head>

<body>
    <!-- IMMERSIVE FULLSCREEN LAUNCH -->
    <div id="fullscreen-launch-overlay">
        <i class="fas fa-leaf fa-beat" style="font-size: 5rem; margin-bottom: 25px;"></i>
        <h1 style="letter-spacing: 12px; font-weight: 900; text-shadow: 0 0 20px var(--primary-glow);">AI AGRO ASSISTANT
        </h1>
        <p style="opacity: 0.6; font-size: 1.1rem; letter-spacing: 2px;">
            EDITION</p>
        <button class="launch-btn" onclick="App.launchImmersiveMode()">
            <i class="fas fa-expand"></i> START BROADCAST EXPERIENCE
        </button>
    </div>
    <button class="chatbot-toggler">
        <span class="fa-solid fa-comments"></span>
        <span class="fa-solid fa-xmark"></span>
    </button>
    <div class="chatbot-container">
        <ul class="chatbox">
            <li class="chat incoming">
                <span class="fa-solid fa-robot"></span>
                <p>Hi there ðŸ‘‹<br>How can I help you today?</p>
            </li>
        </ul>
        <div class="chat-input">
            <textarea placeholder="Enter a message..." required></textarea>
            <span id="send-btn" class="fa-solid fa-paper-plane"></span>
        </div>
    </div>

    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div class="sidebar">
        <div id="sidebar-weather-widget">
            <i class="fas fa-spinner fa-spin"></i>
            <span id="weather-temp">--Â°C</span>
            <span id="weather-location">Loading...</span>
        </div>

        <a href="#" onclick="App.showSection('dashboard', true)" class="nav-dashboard"><i class="fas fa-home"></i>
            <span>Dashboard</span></a>
        <a href="#" onclick="App.showSection('disease', true)"><i class="fas fa-leaf"></i> <span>Crop Guide</span></a>
        <a href="#" onclick="App.showSection('weather', true)"><i class="fas fa-cloud-sun-rain"></i>
            <span>Weather</span></a>
        <a href="#" onclick="App.showSection('prices', true)"><i class="fas fa-tags"></i> <span>Prices</span></a>
        <a href="#" onclick="App.showSection('planner', true)"><i class="fas fa-brain"></i> <span>AI Planner</span></a>
        <a href="#" onclick="App.showSection('buysell', true)"><i class="fas fa-store"></i> <span>Buy/Sell</span></a>
        <a href="#" onclick="App.showSection('news', true)"><i class="fas fa-newspaper"></i> <span>Agri News</span></a>
        <a href="#" onclick="App.showSection('community', true)"><i class="fas fa-users"></i> <span>Community</span></a>
        <a href="#" onclick="App.showSection('loan', true)"><i class="fas fa-hand-holding-usd"></i> <span>Agri
                Loan</span></a>

        <a href="#" id="nav-login" onclick="App.showSection('login', true)"><i class="fas fa-sign-in-alt"></i>
            <span>Login</span></a>
        <a href="#" id="nav-logout" onclick="App.logoutUser()" style="display: none;"><i
                class="fas fa-sign-out-alt"></i> <span>Logout</span></a>
    </div>

    <header>
        <h1><i class="fas fa-leaf"></i>AI Agro Assistant</h1>
        <div class="header-right">
            <button class="voice-assistant-btn" onclick="App.toggleVoiceAssistant()">
                <i class="fas fa-microphone"></i> <span>AI Voice</span>
            </button>
            <div id="google_translate_element" style="position: absolute; opacity: 0; pointer-events: none;"></div>
            <div class="custom-lang-selector" id="custom-lang-selector">
                <button class="lang-btn" onclick="App.toggleLangDropdown()">
                    <i class="fas fa-language"></i> <span id="current-lang-label">Select Language</span>
                </button>
                <div class="lang-dropdown" id="lang-dropdown">
                    <div class="lang-search">
                        <input type="text" id="lang-search-input" placeholder="Search language..."
                            onkeyup="App.filterLanguages()">
                    </div>
                    <div class="lang-list" id="lang-list">

                    </div>
                </div>
            </div>
            <div class="user-profile">
                <img id="header-profile-pic"
                    src="https://i.pinimg.com/736x/c0/27/be/c027bec07c2dc08b9df60921dfd539bd.jpg" alt="Profile Icon">
                <span id="username-display"></span>
                <div class="profile-dropdown">
                    <p>
                        <span><strong>Email:</strong><br><span id="user-email-details"></span></span>
                        <i class="fas fa-pencil-alt edit-profile-btn"
                            onclick="event.stopPropagation(); App.showSection('edit-profile');"></i>
                    </p>
                    <a href="#" onclick="event.preventDefault(); App.logoutUser()">Logout</a>
                </div>
            </div>
            <div class="hamburger-menu">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </header>

    <div class="content">
        <div class="container" id="dashboard">
            <div class="slider-wrapper">
                <div class="slide" onclick="App.showSection('weather')">
                    <img src="https://i.gifer.com/Iqt.gif" class="slide-background-gif" alt="Weather animation">
                    <div class="slide-content">
                        <i class="fas fa-cloud-sun-rain"></i>
                        <h2>Weather Forecast</h2>
                        <p>Get real-time weather updates to plan your farming activities.</p>
                    </div>
                </div>
                <div class="slide" onclick="App.showSection('disease')">
                    <img src="https://s14.gifyu.com/images/bNLvJ.gif" class="slide-background-gif"
                        alt="Crop inspection animation">
                    <div class="slide-content">
                        <i class="fas fa-leaf"></i>
                        <h2>Crop Guide</h2>
                        <p>Upload a leaf image to instantly detect diseases and get a full farming guide.</p>
                    </div>
                </div>
                <div class="slide" onclick="App.showSection('planner')">
                    <img src="https://s14.gifyu.com/images/bNLmY.gif" class="slide-background-gif"
                        alt="Farming planner animation">
                    <div class="slide-content">
                        <i class="fas fa-brain"></i>
                        <h2>AI Planner</h2>
                        <p>Receive intelligent suggestions for crops based on your land and season.</p>
                    </div>
                </div>
                <div class="slide" onclick="App.showSection('prices')">
                    <img src="https://s14.gifyu.com/images/bNLIp.gif" class="slide-background-gif"
                        alt="Market prices animation">
                    <div class="slide-content">
                        <i class="fas fa-tags"></i>
                        <h2>Market Prices</h2>
                        <p>Track the latest vegetable prices in your local market.</p>
                    </div>
                </div>
                <div class="slide" onclick="App.showSection('buysell')">
                    <img src="https://s14.gifyu.com/images/bNLuQ.gif" class="slide-background-gif"
                        alt="Market animation">
                    <div class="slide-content">
                        <i class="fas fa-store"></i>
                        <h2>Market</h2>
                        <p>Directly buy & sell farm products.</p>
                    </div>
                </div>
            </div>
            <div class="slider-nav"></div>
        </div>


        <div class="container" id="edit-profile">
            <div class="box">
                <h2><i class="fas fa-user-edit"></i> Edit Profile</h2>

                <div class="profile-pic-uploader">
                    <img id="profile-pic-preview"
                        src="https://i.pinimg.com/736x/c0/27/be/c027bec07c2dc08b9df60921dfd539bd.jpg"
                        alt="Profile Picture">
                    <label for="profile-pic-input">
                        <i class="fas fa-camera"></i>
                    </label>
                    <input type="file" id="profile-pic-input" accept="image/*">
                </div>

                <form id="edit-profile-form">
                    <label for="profile-name">Name</label>
                    <input type="text" id="profile-name" placeholder="Enter your name" required>

                    <label for="profile-email">Email</label>
                    <input type="email" id="profile-email" disabled>
                    <label for="profile-current-password">Current Password (Required to change password)</label>
                    <input type="password" id="profile-current-password" placeholder="Enter your current password">

                    <label for="profile-new-password">New Password (leave blank to keep current password)</label>
                    <input type="password" id="profile-new-password" placeholder="Enter new password">


                    <div id="profile-update-status" class="result-box" style="display:none;"></div>

                    <div class="form-buttons">
                        <button type="button" class="back-btn" onclick="App.showSection('about')">Back</button>
                        <button type="submit">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>


        <div class="container" id="news">
            <div id="news-loader" style="display: none;">
                <div class="spinner"></div><br>Fetching latest news...
            </div>
            <div class="news-grid" id="news-grid"></div>
        </div>

        <div class="container" id="login">
            <div class="login-page-container" id="login-container">
                <div class="form-container sign-up-container">
                    <form action="#" onsubmit="return false;">
                        <h1>Create Account</h1>
                        <input type="text" id="register-name" placeholder="Name" required />
                        <input type="email" id="register-email" placeholder="Email" required />
                        <input type="password" id="register-password" placeholder="Password" required />
                        <input type="password" id="register-confirm-password" placeholder="Confirm Password" required />
                        <button type="button" onclick="App.registerUser()">Sign Up</button>
                        <div id="register-status" class="result-box"
                            style="display:none; background: transparent; border: none; padding: 10px 0 0 0;"></div>
                    </form>
                </div>
                <div class="form-container sign-in-container">
                    <form action="#" onsubmit="return false;">
                        <h1>Sign In</h1>
                        <input type="email" id="login-email" placeholder="Email" />
                        <input type="password" id="login-password" placeholder="Password" />
                        <button type="button" onclick="App.loginUser()">Sign In</button>
                        <div id="login-status" class="result-box"
                            style="display:none; background: transparent; border: none; padding: 10px 0 0 0;"></div>
                    </form>
                </div>
                <div class="overlay-container">
                    <div class="overlay">
                        <div class="overlay-panel overlay-left">
                            <h1>Welcome Back!</h1>
                            <p>To keep connected with us please login with your personal info</p>
                            <button class="ghost" id="signIn">Sign In</button>
                        </div>
                        <div class="overlay-panel overlay-right">
                            <h1>Hello, Farmer!</h1>
                            <p>Enter your personal details and start your journey with us</p>
                            <button class="ghost" id="signUp">Sign Up</button>
                        </div>
                    </div>
                </div>
                <div class="mobile-toggle-forms" style="display: none;">
                    <span id="mobile-toggle-text">Don't have an account?</span>
                    <button id="mobile-toggle-btn">Sign Up</button>
                </div>
            </div>
        </div>


        <div class="container" id="disease">
            <div class="box" style="max-width: 1200px !important; width: 95%;">
                <h2><i class="fas fa-seedling"></i> Complete Crop Guide</h2>
                <p style="text-align: center; opacity: 0.8; margin-top: -15px;">Official AI Agricultural Diagnosis
                    Engine</p>

                <div class="disease-controls">
                    <div class="file-input-wrapper">
                        <input type="file" name="leaf" id="leafImage" accept="image/*"
                            onchange="App.handleFileSelect(event)">
                        <span class="file-input-label"><i class="fas fa-cloud-upload-alt"></i> Upload Image</span>
                    </div>
                    <button type="button" class="action-btn" onclick="App.startCamera()">
                        <i class="fas fa-camera"></i> Live Camera
                    </button>
                    <button type="button" class="action-btn" id="brief-toggle-btn" onclick="App.toggleBriefMode()">
                        <i class="fas fa-list-ul"></i> Detail Mode
                    </button>
                </div>

                <div class="camera-wrapper" id="camera-wrapper">
                    <video id="camera-video" autoplay playsinline></video>
                    <canvas id="camera-canvas" style="display: none;"></canvas>
                    <div class="camera-btns">
                        <button class="capture-btn" onclick="App.captureAndAnalyze()">
                            <i class="fas fa-record-vinyl"></i> CAPTURE & ANALYZE
                        </button>
                        <button class="stop-cam-btn" onclick="App.stopCamera()">
                            <i class="fas fa-times"></i> STOP
                        </button>
                    </div>
                </div>

                <form id="disease-form" enctype="multipart/form-data" style="text-align: center;">
                    <div class="file-name" id="leaf-file-name"></div>
                    <button type="submit" id="analyze-btn"
                        style="width: 100%; max-width: 600px; margin-top: 10px; font-size: 1.2rem; padding: 15px;">ðŸ”
                        Analyze Leaf</button>
                </form>

                <div id="scan-wrapper" class="scan-container">
                    <div class="scan-line"></div>
                    <img id="scan-preview" src="" alt="Scanning...">
                </div>

                <div id="disease-result" class="result-box" style="border: none; background: transparent; padding: 0;">
                </div>

                <div id="disease-actions-container" style="display: none;">
                    <div class="report-actions">
                        <button class="action-btn" id="speak-report-btn" onclick="App.toggleSpeech()">
                            <i class="fas fa-volume-up"></i> Play Audio
                        </button>
                        <button class="action-btn" onclick="App.downloadPDF()">
                            <i class="fas fa-file-pdf"></i> Download PDF
                        </button>
                        <button class="action-btn" onclick="App.translateUI('Tamil')">
                            Translate: Tamil
                        </button>
                        <button class="action-btn" onclick="App.translateUI('Hindi')">
                            Translate: Hindi
                        </button>
                        <button class="action-btn" onclick="App.translateUI('English')">
                            Original (EN)
                        </button>
                        <button class="action-btn" onclick="App.toggleFollowUpUI()">
                            <i class="fas fa-comment-dots"></i> Ask Question
                        </button>
                    </div>

                    <div class="follow-up-container" id="follow-up-container">
                        <div class="follow-up-chat" id="follow-up-chat">
                            <p style="opacity: 0.6; font-size: 0.9rem;">Ask a follow-up question about this leaf...</p>
                        </div>
                        <div class="follow-up-input-group">
                            <input type="text" id="follow-up-input" placeholder="Type your question here...">
                            <button onclick="App.sendFollowUpQuestion()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                            <button onclick="App.startFollowUpVoice()" title="Ask by Voice">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="history-container" id="analysis-history-container" style="display: none;">
                    <h3><i class="fas fa-history"></i> Recent Analysis History</h3>
                    <div class="history-grid" id="history-grid">
                        <!-- History cards will be injected here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="container" id="weather">
            <div class="box" style="max-width: 1200px !important; width: 95%;">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                    <h2><i class="fas fa-satellite-dish"></i> Advanced Weather Intelligence</h2>
                    <div class="weather-search-form" style="margin: 0; max-width: 400px;">
                        <input type="text" id="city-search-input" placeholder="Search City (e.g. Coimbatore)..."
                            style="background: rgba(255,255,255,0.1); color: white; border-color: var(--glass-border);">
                        <button onclick="App.getWeatherByCity()" style="background: var(--primary-color);"><i
                                class="fas fa-search"></i></button>
                        <button onclick="App.getWeatherByLocation()" title="Live Location"
                            style="background: var(--electric-blue);"><i
                                class="fas fa-location-crosshairs"></i></button>
                    </div>
                </div>

                <div id="weather-output">
                    <!-- The new Weather Hub Grid will be injected here by JS -->
                    <div style="text-align: center; padding: 50px;">
                        <i class="fas fa-cloud-sun fa-bounce"
                            style="font-size: 4rem; color: var(--primary-color); margin-bottom: 20px;"></i>
                        <h3>Select a location or use GPS to unlock weather intelligence</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="container" id="prices">
            <div class="box" style="max-width: 1200px !important; width: 95%;">
                <h2><i class="fas fa-tags"></i> Vegetable Price Tracker</h2>
                <label for="veg-name">ðŸ¥¬ Vegetable Name:</label>
                <input type="text" id="veg-name" placeholder="e.g. Tomato" />
                <label for="veg-location">ðŸ“ Market/City:</label>
                <input type="text" id="veg-location" placeholder="e.g. Coimbatore" />
                <button onclick="App.getPrices()">ðŸ“¦ Get Price & Info</button>
                <div id="price-list" class="result-box planner-result-box"></div>
            </div>
            <div id="vegetable-info-details">
                <div class="veg-image-container">
                    <img id="veg-info-image" src="" alt="Vegetable Image">
                </div>
                <div class="veg-details-container">
                    <h3 id="veg-info-name"></h3>
                    <div id="veg-info-content">
                    </div>
                </div>
            </div>
        </div>
        <div class="container" id="planner">
            <div class="box" style="max-width: 1200px !important; width: 95%;">
                <h2><i class="fas fa-brain"></i> AI Strategic Planner</h2>

                <label for="crop">ðŸŒ¾ Crop Name:</label>
                <input type="text" id="crop" placeholder="e.g., Tomato, Rice" />

                <label for="area">ðŸ“ Land Area (in acres):</label>
                <input type="number" id="area" placeholder="e.g., 5" />

                <label for="location">ðŸ“ Your Location:</label>
                <input type="text" id="location" placeholder="e.g., Chennai, Madurai" />

                <button onclick="App.getPlan()">ðŸ’¡ Get Perfect Plan</button>

                <div id="planner-output" class="result-box planner-result-box"></div>

                <div class="planner-news-section">
                    <h3><i class="fas fa-newspaper"></i> Agri-Planning Intelligence</h3>
                    <div class="planner-news-grid">
                        <div class="planner-news-card">
                            <i class="fas fa-cloud-sun-rain"></i>
                            <h4>Seasonal Smart Alerts</h4>
                            <p>Get real-time alerts on best planting windows based on monsoon predictions.</p>
                        </div>
                        <div class="planner-news-card">
                            <i class="fas fa-chart-line"></i>
                            <h4>Market Trend Analysis</h4>
                            <p>AI-driven crop demand forecasts to help you pick the most profitable crop.</p>
                        </div>
                        <div class="planner-news-card">
                            <i class="fas fa-vial"></i>
                            <h4>Soil Health Insights</h4>
                            <p>Optimization tips for fertilizer usage to maximize yield while saving costs.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container" id="buysell"
            style="flex-direction: column; justify-content: flex-start; align-items: center; padding-top: 50px;">
            <div id="buysell-choice-wrapper"
                style="display: flex; width: 95%; max-width: 1200px; justify-content: center; gap: 20px;">
                <div id="btn-seller-choice" class="choice-card" role="button" tabindex="0">
                    <i class="fas fa-seedling"></i>
                    <h3>I am a Seller</h3>
                    <p>List your fresh farm products for buyers to see.</p>
                </div>
                <div id="btn-buyer-choice" class="choice-card" role="button" tabindex="0">
                    <i class="fas fa-shopping-cart"></i>
                    <h3>I am a Buyer</h3>
                    <p>Browse and buy products directly from farmers.</p>
                </div>
            </div>
            <div id="seller-form-container" class="box"
                style="display: none; width: 100%; max-width: 500px; margin-top: 30px;">
                <h2><i class="fas fa-seedling"></i> Sell Your Product</h2>
                <label for="seller-name">ðŸ‘¤ Seller Name:</label>
                <input type="text" id="seller-name" placeholder="Enter your name">
                <label for="seller-item-name">ðŸ“¦ Product Name:</label>
                <input type="text" id="seller-item-name" placeholder="e.g. Tomato, Onion">
                <label for="seller-location">ðŸ“ Location:</label>
                <input type="text" id="seller-location" placeholder="e.g. Coimbatore, Salem">
                <label for="seller-category">ðŸŒ¾ Category:</label>
                <select id="seller-category">
                    <option value="">-- Select a Category --</option>
                    <option value="vegetables">Vegetable</option>
                    <option value="fruits">Fruit</option>
                    <option value="grains">Grains</option>
                    <option value="other">Other</option>
                </select>
                <label for="seller-item-image">ðŸ–¼ï¸ Product Image:</label>
                <input type="file" id="seller-item-image" accept="image/*">
                <label for="seller-price">ðŸ’° Price (per kg):</label>
                <input type="number" id="seller-price" placeholder="e.g. 25">
                <button onclick="App.submitSellerItem()">ðŸ“¤ Submit Item</button>
                <div id="seller-submit-status" class="result-box"></div>
                <button onclick="App.showBuysellChoice()" style="margin-top: 10px; background-color: #7f8c8d;">â† Go
                    Back</button>
            </div>
        </div>


        <div class="container" id="community">
            <div class="box">
                <h2><i class="fas fa-users"></i> Community Forum</h2>
                <div class="coming-soon-placeholder">
                    <i class="fas fa-comments"></i>
                    <h2>Feature Coming Soon!</h2>
                    <p>We're building a community space for farmers to connect, ask questions, and share knowledge. Stay
                        tuned!</p>
                </div>
            </div>
        </div>

        <div class="container" id="loan">
            <div class="box" style="max-width: 1200px !important; width: 95%;">
                <div id="loan-step-1">
                    <h2><i class="fas fa-hand-holding-usd"></i>Agri Loan: Coming Soon!</h2>
                    <form id="loan-form-initial">
                        <label for="pan-card">PAN Card</label>
                        <div class="file-input-wrapper" style="width: 80%;">
                            <input type="file" name="pan-card" id="pan-card" accept="image/*,application/pdf"
                                required />
                            <span class="file-input-label"><i class="fas fa-id-card"></i>Click to Upload PAN Card</span>
                        </div>
                        <div class="file-name" id="pan-file-name"></div>
                        <label for="passbook">Last 6 Months Bank Statement</label>
                        <div class="file-input-wrapper" style="width: 80%;">
                            <input type="file" name="passbook" id="passbook" accept="image/*,application/pdf"
                                required />
                            <span class="file-input-label"><i class="fas fa-book"></i>Click to Upload Bank
                                Statement</span>
                        </div>
                        <div class="file-name" id="passbook-file-name"></div>
                        <button type="submit">Agri Loan: Coming Soon!</button>
                    </form>
                    <div id="loan-status" class="result-box" style="display:none;"></div>
                </div>
                <div id="loan-step-2" style="display:none;">
                    <h2><i class="fas fa-check-circle"></i> Loan Eligibility</h2>
                    <div id="loan-approval-section" class="loan-suggestion"></div>
                    <button id="get-loan-btn">Get Loan</button>
                </div>
                <div id="loan-step-3" style="display:none;">
                    <h2><i class="fas fa-user-check"></i> Final Application</h2>
                    <form id="loan-form-final" action="https://api.web3forms.com/submit" method="POST">
                        <input type="hidden" name="access_key" value="YOUR_WEB3FORMS_ACCESS_KEY">
                        <input type="hidden" name="subject" value="New Agri Loan Application">
                        <input type="hidden" name="from_name" value="Agro Assistant">
                        <label for="farmer-photo">Your Photo</label>
                        <div class="file-input-wrapper" style="width: 80%;">
                            <input type="file" name="farmer_photo" id="farmer-photo" accept="image/*" required>
                            <span class="file-input-label"><i class="fas fa-camera"></i>Upload Your Photo</span>
                        </div>
                        <div class="file-name" id="photo-file-name"></div>
                        <label for="address">Full Address</label>
                        <textarea name="address" id="address" required placeholder="Enter your full address"></textarea>
                        <label for="bank-details">Bank Account Details (for loan deposit)</label>
                        <textarea name="bank_details" id="bank-details" required
                            placeholder="Bank Name, Account Number, IFSC Code"></textarea>
                        <div class="terms-box">
                            <p><strong>Terms and Conditions:</strong></p>
                            <ul>
                                <li>The loan amount is subject to final verification by our team.</li>
                                <li>The interest rate for the loan is fixed at <strong>1% per annum</strong>.</li>
                                <li>Repayment must be made in equal monthly installments over the agreed tenure.</li>
                                <li>Failure to repay on time may result in penalties as per the agreement.</li>
                                <li>All information provided must be accurate and truthful.</li>
                            </ul>
                        </div>
                        <div class="terms-check">
                            <input type="checkbox" id="terms" name="terms" required>
                            <label for="terms">I agree to the terms and conditions.</label>
                        </div>
                        <button type="submit">Submit Final Application</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="image-modal-overlay">
        <div id="image-modal-content">
            <span id="image-modal-close" onclick="App.closeImageModal()">Ã—</span>
            <img id="full-image" src="" alt="Full-size user image">
        </div>
    </div>

    <div id="news-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <span class="modal-close" onclick="App.closeNewsModal()">Ã—</span>
            <iframe id="news-iframe" src="" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen></iframe>
        </div>
    </div>

    <div id="final-popup" class="popup-overlay">
        <div class="popup-content"><i class="fas fa-check-circle"></i>
            <p>Our agent will get you back soon</p><button class="popup-close-btn"
                onclick="App.closeFinalPopup()">Close</button>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({ pageLanguage: 'en', layout: google.translate.TranslateElement.InlineLayout.SIMPLE }, 'google_translate_element');
        }
    </script>
    <script type="text/javascript"
        src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    <script>
        const App = {
            API_BASE_URL: 'http://127.0.0.1:5000',
            services: { auth: null, db: null, storage: null },
            newsLoaded: false,
            tutorialsLoaded: false,
            isNewUser: false,
            profilePicFile: null,
            isBriefMode: false,
            cameraStream: null,
            currentReportText: "",
            isSpeaking: false,
            speechInstance: null,
            slider: {
                interval: null,
                currentIndex: 0,
                wrapper: null,
                nav: null,
                slidesCount: 5
            },
            chatbot: {
                toggler: null,
                sendBtn: null,
                input: null,
                chatbox: null
            },
            languages: [
                { code: 'en', name: 'English' },
                { code: 'ta', name: 'Tamil' },
                { code: 'hi', name: 'Hindi' },
                { code: 'te', name: 'Telugu' },
                { code: 'kn', name: 'Kannada' },
                { code: 'ml', name: 'Malayalam' },
                { code: 'mr', name: 'Marathi' },
                { code: 'gu', name: 'Gujarati' },
                { code: 'bn', name: 'Bengali' },
                { code: 'pa', name: 'Punjabi' },
                { code: 'ur', name: 'Urdu' },
                { code: 'fr', name: 'French' },
                { code: 'de', name: 'German' },
                { code: 'es', name: 'Spanish' },
                { code: 'zh-CN', name: 'Chinese' },
                { code: 'ja', name: 'Japanese' },
                { code: 'ar', name: 'Arabic' }
            ],

            init: function () {
                document.addEventListener('DOMContentLoaded', () => {
                    this.initServices();
                    this.bindEvents();
                    this.initLangSelector();
                    this.initChatbot();
                    this.loadHistory();
                    this.services.auth.onAuthStateChanged(this.handleAuthStateChange.bind(this));
                });
            },

            initServices: function () {
                const firebaseConfig = {
                    apiKey: "AIzaSyCXK0KHqLhKVAAm5xr0ASbFKJM5IwVLeTY",
                    authDomain: "agri--sps-project.firebaseapp.com",
                    projectId: "agri--sps-project",
                    storageBucket: "agri--sps-project.appspot.com",
                    messagingSenderId: "762110077628",
                    appId: "1:762110077628:web:9d219b9d67bbecf270beb9",
                    measurementId: "G-CZ1QZ6437H"
                };
                firebase.initializeApp(firebaseConfig);
                this.services.auth = firebase.auth();
                this.services.db = firebase.firestore();
                this.services.storage = firebase.storage();
            },

            bindEvents: function () {
                // Desktop Login Panel Toggle
                const signUpButton = document.getElementById('signUp');
                const signInButton = document.getElementById('signIn');
                const container = document.getElementById('login-container');

                if (signUpButton && signInButton && container) {
                    signUpButton.addEventListener('click', () => container.classList.add('right-panel-active'));
                    signInButton.addEventListener('click', () => container.classList.remove('right-panel-active'));
                }

                // Mobile Login/Signup Toggle
                const mobileToggleBtn = document.getElementById('mobile-toggle-btn');
                if (mobileToggleBtn) {
                    mobileToggleBtn.addEventListener('click', this.toggleMobileForms.bind(this));
                }

                // Hamburger Menu Toggle
                const hamburger = document.querySelector('.hamburger-menu');
                if (hamburger) {
                    hamburger.addEventListener('click', () => {
                        document.body.classList.toggle('mobile-nav-open');
                    });
                }

                // Profile Dropdown
                const userProfile = document.querySelector('.user-profile');
                if (userProfile) {
                    userProfile.addEventListener('click', (e) => {
                        e.stopPropagation();
                        userProfile.classList.toggle('active');
                    });
                }
                document.addEventListener('click', (e) => {
                    const activeProfile = document.querySelector('.user-profile.active');
                    if (activeProfile && !activeProfile.contains(e.target)) {
                        activeProfile.classList.remove('active');
                    }
                });

                // Form event listeners
                document.getElementById('disease-form').addEventListener('submit', (e) => { e.preventDefault(); this.predictDisease(e.currentTarget); });
                document.getElementById('edit-profile-form').addEventListener('submit', (e) => { e.preventDefault(); this.handleProfileUpdate(); });
                document.getElementById('profile-pic-input').addEventListener('change', (e) => { this.previewProfilePic(e); });


                document.getElementById('btn-seller-choice').addEventListener('click', () => this.showSellerForm());
                document.getElementById('btn-buyer-choice').addEventListener('click', () => this.redirectToBuyerPage());

                document.getElementById('loan-form-initial').addEventListener('submit', (e) => { e.preventDefault(); this.handleInitialLoanSubmit(); });
                document.getElementById('get-loan-btn').addEventListener('click', () => this.showFinalLoanForm());
                document.getElementById('loan-form-final').addEventListener('submit', (e) => { e.preventDefault(); this.handleFinalLoanSubmit(e.target); });

                document.getElementById('pan-card').addEventListener('change', (e) => {
                    const fileName = e.target.files[0] ? e.target.files[0].name : '';
                    document.getElementById('pan-file-name').textContent = fileName;
                });
                document.getElementById('passbook').addEventListener('change', (e) => {
                    const fileName = e.target.files[0] ? e.target.files[0].name : '';
                    document.getElementById('passbook-file-name').textContent = fileName;
                });
                document.getElementById('farmer-photo').addEventListener('change', (e) => {
                    const fileName = e.target.files[0] ? e.target.files[0].name : '';
                    document.getElementById('photo-file-name').textContent = fileName;
                });
            },

            handleFileSelect: function (event) {
                const fileName = event.target.files[0] ? event.target.files[0].name : '';
                document.getElementById('leaf-file-name').textContent = fileName;
            },

            showSection: function (sectionId, fromMobileNav = false) {
                const sections = ['dashboard', 'about', 'disease', 'weather', 'prices', 'planner', 'login', 'buysell', 'news', 'loan', 'tutorials', 'community', 'edit-profile'];
                clearInterval(this.slider.interval);

                sections.forEach(id => {
                    const container = document.getElementById(id);
                    if (container) container.style.display = 'none'; // Hide all sections first
                });

                // Show the selected section
                const sectionToShow = document.getElementById(sectionId);
                if (sectionToShow) {
                    sectionToShow.style.display = 'flex';
                }

                if (sectionId === 'dashboard') {
                    this.initDashboardSlider();
                } else if (sectionId === 'weather') {
                    this.getWeatherByLocation(); // Auto-fetch on entry
                } else if (sectionId === 'login') {
                    this.setupMobileLoginView(); // Setup mobile login view correctly
                    document.getElementById('login-container')?.classList.remove('right-panel-active');
                } else if (sectionId === 'buysell') {
                    this.showBuysellChoice();
                } else if (sectionId === 'edit-profile') {
                    this.populateProfileForm();
                } else if (sectionId === 'news' && !this.newsLoaded) {
                    this.showLoadingOverlay(true);
                    this.getNews().finally(() => this.showLoadingOverlay(false));
                } else if (sectionId === 'tutorials' && !this.tutorialsLoaded) {
                    this.getTutorials('latest farming techniques'); // Initial search
                    this.tutorialsLoaded = true; // Prevent re-loading on every click
                } else if (sectionId === 'loan') {
                    document.getElementById('loan-step-1').style.display = 'block';
                    document.getElementById('loan-step-2').style.display = 'none';
                    document.getElementById('loan-step-3').style.display = 'none';
                    document.getElementById('loan-status').style.display = 'none';
                }

                // If a link in the mobile nav was clicked, close the nav
                if (fromMobileNav) {
                    document.body.classList.remove('mobile-nav-open');
                }
                document.querySelector('.user-profile')?.classList.remove('active');
            },

            initChatbot: function () {
                this.chatbot.toggler = document.querySelector(".chatbot-toggler");
                this.chatbot.sendBtn = document.getElementById("send-btn");
                this.chatbot.input = document.querySelector(".chat-input textarea");
                this.chatbot.chatbox = document.querySelector(".chatbox");

                this.chatbot.toggler.addEventListener("click", () => document.body.classList.toggle("show-chatbot"));
                this.chatbot.sendBtn.addEventListener("click", () => this.handleChat());
                this.chatbot.input.addEventListener("keydown", (e) => {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        this.handleChat();
                    }
                });
            },

            createChatLi: function (message, className) {
                const chatLi = document.createElement("li");
                chatLi.classList.add("chat", className);
                let chatContent = className === "outgoing"
                    ? `<p>${message}</p>`
                    : `<span class="fa-solid fa-robot"></span><p>${message}</p>`;
                chatLi.innerHTML = chatContent;
                return chatLi;
            },

            generateResponse: async function (userMessage) {
                const thinkingLi = this.createChatLi("Thinking...", "incoming");
                this.chatbot.chatbox.appendChild(thinkingLi);
                this.chatbot.chatbox.scrollTo(0, this.chatbot.chatbox.scrollHeight);

                try {
                    const response = await fetch(`${this.API_BASE_URL}/ask-agro-assistant`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ question: userMessage })
                    });

                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error || "Something went wrong.");
                    }

                    const data = await response.json();
                    thinkingLi.querySelector("p").textContent = data.answer;

                } catch (error) {
                    thinkingLi.querySelector("p").textContent = "Oops! Something went wrong. Please try again.";
                    thinkingLi.querySelector("p").style.color = "#d9534f";
                } finally {
                    this.chatbot.chatbox.scrollTo(0, this.chatbot.chatbox.scrollHeight);
                }
            },

            handleChat: function () {
                const userMessage = this.chatbot.input.value.trim();
                if (!userMessage) return;

                this.chatbot.input.value = "";
                this.chatbot.chatbox.appendChild(this.createChatLi(userMessage, "outgoing"));
                this.chatbot.chatbox.scrollTo(0, this.chatbot.chatbox.scrollHeight);

                setTimeout(() => {
                    this.generateResponse(userMessage);
                }, 600);
            },

            handleAuthStateChange: function (user) {
                const navItems = document.querySelectorAll('.sidebar a:not(#nav-login):not(#nav-logout)');
                const loginLink = document.getElementById('nav-login');
                const logoutLink = document.getElementById('nav-logout');
                const userProfileDiv = document.querySelector('.user-profile');
                const header = document.querySelector('header');
                const content = document.querySelector('.content');
                const weatherWidget = document.getElementById('sidebar-weather-widget');
                const isMobile = window.innerWidth <= 768;

                if (user) {
                    loginLink.style.display = 'none';
                    logoutLink.style.display = 'flex';
                    userProfileDiv.style.display = 'flex';
                    weatherWidget.style.display = isMobile ? 'none' : 'flex';
                    navItems.forEach(item => item.style.display = 'flex');
                    header.style.display = 'flex';
                    content.style.display = 'block';

                    this.updateHeaderProfile(user);

                    // Hide dashboard link on mobile
                    const dashboardLink = document.querySelector('.nav-dashboard');
                    if (dashboardLink) dashboardLink.style.display = isMobile ? 'none' : 'flex';

                    // Determine which section to show
                    if (isMobile) {
                        this.showSection('dashboard'); // Default to dashboard even on mobile now
                        document.body.classList.add('mobile-nav-open');
                    } else {
                        this.showSection('dashboard');
                    }

                    this.fetchSidebarWeather();
                } else { // User is logged out
                    loginLink.style.display = 'flex';
                    logoutLink.style.display = 'none';
                    userProfileDiv.style.display = 'none';
                    weatherWidget.style.display = 'none';
                    navItems.forEach(item => item.style.display = 'none');
                    this.showSection('login');
                    this.newsLoaded = false;
                }
            },

            updateHeaderProfile: function (user) {
                const username = user.displayName || user.email.split('@')[0];
                const photoURL = user.photoURL || 'https://i.pinimg.com/736x/c0/27/be/c027bec07c2dc08b9df60921dfd539bd.jpg';
                document.getElementById('username-display').textContent = username;
                document.getElementById('user-email-details').textContent = user.email;
                document.getElementById('header-profile-pic').src = photoURL;
            },

            registerUser: function () {
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                const statusDiv = document.getElementById('register-status');
                statusDiv.style.display = 'block';

                if (!name || !email || !password || !confirmPassword) {
                    statusDiv.innerHTML = `<p style="color:red;">Please fill in all fields.</p>`;
                    return;
                }
                if (password !== confirmPassword) {
                    statusDiv.innerHTML = `<p style="color:red;">Passwords do not match.</p>`;
                    return;
                }
                statusDiv.innerHTML = `<p style="color:blue;">Registering...</p>`;
                this.services.auth.createUserWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        return userCredential.user.updateProfile({
                            displayName: name
                        }).then(() => {
                            statusDiv.innerHTML = `<p style="color:green;">Registration successful! Please login.</p>`;
                            this.isNewUser = true;
                            this.updateUserCountInDB();
                            if (window.innerWidth > 768) {
                                setTimeout(() => document.getElementById('signIn').click(), 1500);
                            } else {
                                setTimeout(() => this.toggleMobileForms(), 1500);
                            }
                        });
                    })
                    .catch(error => {
                        statusDiv.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
                    });
            },

            loginUser: function () {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const statusDiv = document.getElementById('login-status');
                statusDiv.style.display = 'block';

                if (!email || !password) {
                    statusDiv.innerHTML = `<p style="color:red;">Please enter both email and password.</p>`;
                    return;
                }
                statusDiv.innerHTML = `<p style="color:blue;">Logging in...</p>`;
                this.services.auth.signInWithEmailAndPassword(email, password)
                    .catch(error => {
                        statusDiv.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
                    });
            },

            logoutUser: function () {
                this.services.auth.signOut().catch(error => console.error('Sign out error', error));
            },

            populateProfileForm: function () {
                const user = this.services.auth.currentUser;
                if (!user) return;

                const photoURL = user.photoURL || 'https://i.pinimg.com/736x/c0/27/be/c027bec07c2dc08b9df60921dfd539bd.jpg';
                document.getElementById('profile-pic-preview').src = photoURL;
                document.getElementById('profile-name').value = user.displayName || '';
                document.getElementById('profile-email').value = user.email || '';
                document.getElementById('profile-new-password').value = '';
                document.getElementById('profile-update-status').style.display = 'none';
                this.profilePicFile = null;
            },

            previewProfilePic: function (event) {
                const file = event.target.files[0];
                if (file) {
                    this.profilePicFile = file; // Store the file
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById('profile-pic-preview').src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            },

            handleProfileUpdate: async function () {
                const user = this.services.auth.currentUser;
                if (!user) return;

                const statusDiv = document.getElementById('profile-update-status');
                this.showLoadingOverlay(true);
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = '<p style="color:blue;">Updating profile...</p>';

                try {
                    const newName = document.getElementById('profile-name').value;
                    const newPassword = document.getElementById('profile-new-password').value;
                    const currentPassword = document.getElementById('profile-current-password').value;

                    // --- PASSWORD UPDATE LOGIC STARTS HERE ---
                    if (newPassword) {
                        if (!currentPassword) {
                            throw new Error("Please enter your current password to set a new one.");
                        }
                        const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
                        await user.reauthenticateWithCredential(credential);
                        await user.updatePassword(newPassword);
                    }
                    // --- PASSWORD UPDATE LOGIC ENDS HERE ---


                    let photoURL = user.photoURL;
                    if (this.profilePicFile) {
                        const formData = new FormData();
                        formData.append('profile_image', this.profilePicFile);

                        const response = await fetch(`${this.API_BASE_URL}/upload-profile-image`, {
                            method: 'POST',
                            body: formData,
                        });

                        if (!response.ok) {
                            throw new Error('Image upload failed.');
                        }
                        const result = await response.json();
                        photoURL = result.secure_url;
                    }

                    await user.updateProfile({
                        displayName: newName,
                        photoURL: photoURL
                    });

                    this.updateHeaderProfile(this.services.auth.currentUser);
                    statusDiv.innerHTML = '<p style="color:green;">Profile updated successfully!</p>';
                    this.profilePicFile = null;
                    document.getElementById('profile-current-password').value = '';
                    document.getElementById('profile-new-password').value = '';

                } catch (error) {
                    console.error("Profile update error:", error);
                    statusDiv.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
                } finally {
                    this.showLoadingOverlay(false);
                }
            },

            handleInitialLoanSubmit: async function () {
                const loanStatusDiv = document.getElementById('loan-status');
                const panFile = document.getElementById('pan-card').files[0];
                const passbookFile = document.getElementById('passbook').files[0];

                if (!panFile || !passbookFile) {
                    loanStatusDiv.style.display = 'block';
                    loanStatusDiv.innerHTML = `<p style="color:red;">Please upload both documents.</p>`;
                    return;
                }

                this.showLoadingOverlay(true);
                loanStatusDiv.style.display = 'block';
                loanStatusDiv.innerHTML = `<p style="color:blue;">Analyzing your documents... Please wait.</p>`;

                setTimeout(() => {
                    const isSuccess = Math.random() > 0.3;
                    if (isSuccess) {
                        const suggestedAmount = Math.floor(Math.random() * (500000 - 50000 + 1)) + 50000;
                        document.getElementById('loan-approval-section').innerHTML = `
                            <h3><i class="fas fa-check-circle"></i> Eligibility Successful!</h3>
                            <p>Based on your documents, you are eligible for a loan amount up to:</p>
                            <h3>â‚¹${suggestedAmount.toLocaleString('en-IN')}</h3>
                        `;
                        document.getElementById('loan-step-1').style.display = 'none';
                        document.getElementById('loan-step-2').style.display = 'block';
                    } else {
                        loanStatusDiv.innerHTML = `<p style="color:red;"><b>Loan Application Rejected.</b> The provided documents do not meet our eligibility criteria.</p>`;
                    }
                    this.showLoadingOverlay(false);
                }, 3000);
            },

            showFinalLoanForm: function () {
                document.getElementById('loan-step-2').style.display = 'none';
                document.getElementById('loan-step-3').style.display = 'block';
            },

            handleFinalLoanSubmit: async function (form) {
                this.showLoadingOverlay(true);
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: "POST",
                    body: formData,
                    headers: { 'Accept': 'application/json' }
                });

                if (response.ok) {
                    this.showLoadingOverlay(false);
                    document.getElementById('final-popup').style.display = 'flex';
                    form.reset();
                    this.showSection('loan');
                } else {
                    this.showLoadingOverlay(false);
                    const result = await response.json();
                    alert(result.message || "An error occurred. Please try again.");
                }
            },

            closeFinalPopup: function () {
                document.getElementById('final-popup').style.display = 'none';
            },


            updateUserCountInDB: function () {
                console.log("Simulating: Updating user count in the database.");
            },
            getNews: async function () {
                const newsGrid = document.getElementById('news-grid');
                newsGrid.innerHTML = '';

                try {
                    const response = await fetch(`${this.API_BASE_URL}/agri-news`);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.articles && data.articles.length > 0) {
                        data.articles.forEach(article => {
                            newsGrid.innerHTML += `
                    <a href="#" onclick="event.preventDefault(); App.openNewsModal('${article.url}')" class="news-card">
                        <img src="${article.urlToImage || 'https://images.unsplash.com/photo-1586348943529-beaae6c28db9?auto=format&fit=crop&q=80&w=1915&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'}" alt="News Image" class="news-card-img">
                        <div class="news-card-content">
                            <h3>${article.title}</h3>
                            <p>${article.description || "No description available."}</p>
                            <div class="news-card-footer">
                                <strong>Agro Assistant</strong> - ${new Date(article.publishedAt).toLocaleDateString()}
                            </div>
                        </div>
                    </a>
                `;
                        });
                        this.newsLoaded = true;
                    } else {
                        newsGrid.innerHTML = '<p style="color: white; text-align: center; width: 100%; z-index: 5;">No agricultural news found.</p>';
                    }
                } catch (e) {
                    console.error("Failed to fetch news:", e);
                    newsGrid.innerHTML = `<p style='color: #ffcccc; text-align:center; width: 100%; z-index: 5;'>Error fetching news: ${e.message}.</p>`;
                }
            },

            fetchSidebarWeather: function () {
                const widget = document.getElementById('sidebar-weather-widget');
                const iconEl = widget.querySelector('i');
                const tempEl = document.getElementById('weather-temp');
                const locationEl = document.getElementById('weather-location');
                if (!("geolocation" in navigator)) {
                    locationEl.textContent = 'Geolocation N/A';
                    return;
                }
                navigator.geolocation.getCurrentPosition(async (position) => {
                    try {
                        const { latitude, longitude } = position.coords;
                        const response = await fetch(`${this.API_BASE_URL}/weather?lat=${latitude}&lon=${longitude}`);
                        const data = await response.json();
                        if (data.error) throw new Error(data.error);

                        tempEl.innerHTML = `${Math.round(data.current.temp)}Â°C`;
                        locationEl.textContent = data.city_name;
                        iconEl.className = `fas ${this.getWeatherIconClass(data.current.weather[0])}`;
                        widget.querySelector('.sidebar-weather-info')?.classList.add('visible');
                    } catch (error) {
                        locationEl.textContent = 'Weather Unavailable';
                        iconEl.className = 'fas fa-exclamation-triangle';
                        console.error("Sidebar weather failed:", error);
                    }
                }, () => {
                    locationEl.textContent = 'Location Blocked';
                });
            },

            toggleBriefMode: function () {
                this.isBriefMode = !this.isBriefMode;
                const btn = document.getElementById('brief-toggle-btn');
                btn.innerHTML = this.isBriefMode ? '<i class="fas fa-bolt"></i> Brief Mode' : '<i class="fas fa-list-ul"></i> Detail Mode';
                btn.classList.toggle('active', this.isBriefMode);

                // Toggle CSS class for result container
                const resultDiv = document.getElementById('disease-result');
                if (this.isBriefMode) {
                    resultDiv.classList.add('brief-mode-active');
                } else {
                    resultDiv.classList.remove('brief-mode-active');
                }

                // If there's an existing report, re-render it if needed 
                // (or contextually let CSS handle it)
            },

            startCamera: async function () {
                const wrapper = document.getElementById('camera-wrapper');
                const video = document.getElementById('camera-video');
                try {
                    this.cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    video.srcObject = this.cameraStream;
                    wrapper.style.display = 'block';
                    document.getElementById('disease-form').style.display = 'none';
                } catch (err) {
                    console.error("Camera error:", err);
                    alert("Could not access camera. Please check permissions.");
                }
            },

            stopCamera: function () {
                if (this.cameraStream) {
                    this.cameraStream.getTracks().forEach(track => track.stop());
                    this.cameraStream = null;
                }
                document.getElementById('camera-wrapper').style.display = 'none';
                document.getElementById('disease-form').style.display = 'block';
            },

            captureAndAnalyze: function () {
                const video = document.getElementById('camera-video');
                const canvas = document.getElementById('camera-canvas');
                const context = canvas.getContext('2d');

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                canvas.toBlob((blob) => {
                    const file = new File([blob], "captured_leaf.jpg", { type: "image/jpeg" });
                    this.predictDisease(null, file);
                    this.stopCamera();
                }, 'image/jpeg');
            },

            predictDisease: async function (form, directFile = null) {
                const resultDiv = document.getElementById('disease-result');
                const scanWrapper = document.getElementById('scan-wrapper');
                const scanPreview = document.getElementById('scan-preview');
                const formData = new FormData();

                let file;
                if (directFile) {
                    file = directFile;
                    formData.append('source', 'camera');
                } else {
                    const fileInput = document.getElementById('leafImage');
                    if (!fileInput.files[0]) return alert("Please select a leaf image first.");
                    file = fileInput.files[0];
                    formData.append('source', 'upload');
                }

                formData.append('leaf', file);
                formData.append('brief', false); // Always get full analysis, let UI toggle brief if needed

                // Store image for history (briefly as data URL)
                const reader = new FileReader();
                let imageDataURL = "";
                reader.onload = (e) => {
                    imageDataURL = e.target.result;
                    scanPreview.src = imageDataURL;
                    scanWrapper.style.display = 'block';
                };
                reader.readAsDataURL(file);

                resultDiv.innerHTML = '<p style="color: var(--primary-color); text-align: center;">AI is analyzing your crop... <i class="fas fa-spinner fa-spin"></i></p>';
                document.getElementById('disease-actions-container').style.display = 'none';

                try {
                    const response = await fetch(`${this.API_BASE_URL}/predict`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) throw new Error('Analysis failed.');

                    const data = await response.json();
                    this.currentReportText = data.prediction_text;
                    this.displayAttractiveReport(this.currentReportText);
                    document.getElementById('disease-actions-container').style.display = 'block';

                    // Save to history
                    this.saveToHistory(this.currentReportText, imageDataURL);

                } catch (e) {
                    resultDiv.innerHTML = `<p style="color:red; text-align:center;">Error: ${e.message}</p>`;
                } finally {
                    scanWrapper.style.display = 'none';
                }
            },

            saveToHistory: function (reportText, imageData) {
                const history = JSON.parse(localStorage.getItem('crop_analysis_history') || '[]');

                // Extract crop name and status
                const lines = reportText.split('\n');
                let cropName = "Unknown Crop";
                let status = "Unknown Status";
                let severity = "N/A";

                for (let line of lines) {
                    if (line.includes("Crop name:")) cropName = line.split(':')[1].trim();
                    if (line.includes("Leaf Condition:") || line.includes("LEAF CONDITION")) {
                        // Look for the next line or content
                        status = line.includes(':') ? line.split(':')[1].trim() : "Analysis Done";
                    }
                    if (line.includes("Severity:")) severity = line.split(':')[1].trim();
                }

                const newEntry = {
                    id: Date.now(),
                    crop: cropName,
                    status: status,
                    severity: severity,
                    date: new Date().toLocaleString(),
                    image: imageData,
                    report: reportText
                };

                history.unshift(newEntry);
                const updatedHistory = history.slice(0, 3); // Keep only last 3
                localStorage.setItem('crop_analysis_history', JSON.stringify(updatedHistory));
                this.loadHistory();
            },

            loadHistory: function () {
                const history = JSON.parse(localStorage.getItem('crop_analysis_history') || '[]');
                const historyContainer = document.getElementById('analysis-history-container');
                const historyGrid = document.getElementById('history-grid');

                if (history.length === 0) {
                    historyContainer.style.display = 'none';
                    return;
                }

                historyContainer.style.display = 'block';
                historyGrid.innerHTML = '';

                history.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'history-card';
                    card.onclick = () => {
                        this.currentReportText = item.report;
                        this.displayAttractiveReport(item.report);
                        document.getElementById('disease-actions-container').style.display = 'block';
                        window.scrollTo({ top: document.getElementById('disease').offsetTop - 100, behavior: 'smooth' });
                    };

                    card.innerHTML = `
                        <img src="${item.image}" class="history-img" alt="Analyzed Leaf">
                        <div class="history-info">
                            <span class="history-crop">${item.crop}</span>
                            <span class="history-status">${item.status}</span>
                            <span class="history-date">${item.date}</span>
                        </div>
                    `;
                    historyGrid.appendChild(card);
                });
            },

            downloadPDF: async function () {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const reportElement = document.getElementById('disease-result');
                const analyzedImg = document.getElementById('scan-preview').src;

                this.showLoadingOverlay(true);

                try {
                    // Header
                    doc.setFillColor(39, 174, 96); // Green header
                    doc.rect(0, 0, 210, 30, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(20);
                    doc.text("AI AGRO ASSISTANT", 105, 15, { align: "center" });
                    doc.setFontSize(12);
                    doc.text("Crop Health Diagnosis Report", 105, 25, { align: "center" });

                    // Date & Time
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    doc.text(`Generated on: ${new Date().toLocaleString()}`, 10, 40);

                    let currentY = 50;

                    // Add Analyzed Image if available
                    if (analyzedImg && analyzedImg.startsWith('data:image')) {
                        try {
                            doc.addImage(analyzedImg, 'JPEG', 75, currentY, 60, 45);
                            currentY += 55;
                        } catch (e) { console.error("PDF Image Error", e); }
                    }

                    // Content from report
                    const lines = reportElement.innerText.split('\n');
                    doc.setFontSize(11);

                    lines.forEach(line => {
                        if (currentY > 280) {
                            doc.addPage();
                            currentY = 20;
                        }

                        const trimmed = line.trim();
                        if (!trimmed) return;

                        if (trimmed === trimmed.toUpperCase() && trimmed.length > 3) {
                            doc.setFont(undefined, 'bold');
                            doc.setTextColor(39, 174, 96);
                            currentY += 5;
                            doc.text(trimmed, 10, currentY);
                            currentY += 5;
                            doc.setFont(undefined, 'normal');
                            doc.setTextColor(0, 0, 0);
                        } else {
                            const splitText = doc.splitTextToSize(trimmed, 180);
                            doc.text(splitText, 10, currentY);
                            currentY += (splitText.length * 5);
                        }
                    });

                    // Footer
                    doc.setFontSize(10);
                    doc.setTextColor(150, 150, 150);
                    doc.text("Generated by AI AGRO ASSISTANT - Smart Farming with Artificial Intelligence", 105, 290, { align: "center" });

                    doc.save(`Agro_Report_${Date.now()}.pdf`);
                } catch (err) {
                    console.error("PDF Generation Error:", err);
                    alert("Could not generate PDF. Please try again.");
                } finally {
                    this.showLoadingOverlay(false);
                }
            },

            displayAttractiveReport: function (reportText) {
                const resultDiv = document.getElementById('disease-result');
                resultDiv.innerHTML = '';

                if (this.isBriefMode) resultDiv.classList.add('brief-mode-active');
                else resultDiv.classList.remove('brief-mode-active');

                const header = document.createElement('div');
                header.className = 'report-header';
                header.innerHTML = `<h3><i class="fas fa-building-columns"></i> AGRICULTURE DEPARTMENT - AI REPORT</h3>`;
                resultDiv.appendChild(header);

                const scrollable = document.createElement('div');
                scrollable.className = 'report-scrollable';

                const lines = reportText.split('\n');
                let currentSection = null;
                let inKeyActionBlock = false;

                lines.forEach(line => {
                    const trimmed = line.trim();
                    if (!trimmed) return;

                    // Priority Status Check
                    if (trimmed.includes('ðŸŸ¢') || trimmed.includes('ðŸŸ¡') || trimmed.includes('ðŸ”´')) {
                        const statusDiv = document.createElement('div');
                        statusDiv.className = 'priority-status';
                        statusDiv.innerHTML = trimmed;
                        scrollable.appendChild(statusDiv);
                        return;
                    }

                    // Key Action Block Start
                    if (trimmed === "KEY ACTION BLOCK") {
                        if (currentSection) scrollable.appendChild(currentSection);
                        currentSection = document.createElement('div');
                        currentSection.className = 'report-section action-block';
                        currentSection.innerHTML = `<h3><i class="fas fa-exclamation-triangle"></i> KEY ACTIONS</h3>`;
                        inKeyActionBlock = true;
                        return;
                    }

                    // Detect headings
                    if (trimmed === trimmed.toUpperCase() && trimmed.length > 3 && !trimmed.startsWith('-')) {
                        if (currentSection) scrollable.appendChild(currentSection);
                        inKeyActionBlock = false;
                        currentSection = document.createElement('div');
                        currentSection.className = 'report-section';
                        currentSection.innerHTML = `<h3>${trimmed}</h3>`;
                    } else if (currentSection) {
                        if (inKeyActionBlock && trimmed.includes(':')) {
                            const [label, ...valParts] = trimmed.split(':');
                            const value = valParts.join(':').trim();
                            const item = document.createElement('div');
                            item.className = 'action-item';
                            item.innerHTML = `<span class="action-label">${label}</span><span class="action-value">${value}</span>`;
                            currentSection.appendChild(item);
                        } else {
                            const p = document.createElement('p');
                            p.textContent = trimmed.startsWith('-') ? trimmed : `â€¢ ${trimmed}`;

                            // Highlight medicine names
                            if (trimmed.toLowerCase().includes('medicine name:') || trimmed.toLowerCase().includes('solution:')) {
                                p.innerHTML = p.innerHTML.replace(/: (.*)/, ': <span class="medicine-name">$1</span>');
                            }

                            p.style.margin = "5px 0";
                            p.style.fontSize = "0.95rem";
                            currentSection.appendChild(p);
                        }
                    } else {
                        const p = document.createElement('p');
                        p.textContent = trimmed;
                        scrollable.appendChild(p);
                    }
                });

                if (currentSection) scrollable.appendChild(currentSection);
                resultDiv.appendChild(scrollable);

                // Final reassuring footer
                const footer = document.createElement('p');
                footer.style.textAlign = "center";
                footer.style.marginTop = "20px";
                footer.style.fontWeight = "600";
                footer.style.color = "var(--primary-color)";
                footer.textContent = "This problem is common and controllable. Follow the steps and your crop will recover.";
                resultDiv.appendChild(footer);
            },

            translateUI: async function (lang) {
                const resultDiv = document.getElementById('disease-result');
                const oldContent = resultDiv.innerHTML;
                resultDiv.innerHTML = `<p style="text-align:center; color: var(--electric-blue);">Translating to ${lang}... <i class="fas fa-sync fa-spin"></i></p>`;

                try {
                    const response = await fetch(`${this.API_BASE_URL}/translate-report`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: this.currentReportText, language: lang })
                    });
                    const data = await response.json();
                    if (data.translated_text) {
                        this.displayAttractiveReport(data.translated_text);
                    } else {
                        throw new Error("Translation failed");
                    }
                } catch (err) {
                    alert("Could not translate. Showing original.");
                    resultDiv.innerHTML = oldContent;
                }
            },

            toggleSpeech: function () {
                if (this.isSpeaking) {
                    window.speechSynthesis.cancel();
                    this.isSpeaking = false;
                    document.getElementById('speak-report-btn').innerHTML = '<i class="fas fa-volume-up"></i> Play Audio';
                } else {
                    const textToSpeak = document.getElementById('disease-result').innerText;
                    this.speechInstance = new SpeechSynthesisUtterance(textToSpeak);

                    // Try to pick a nice voice
                    const voices = window.speechSynthesis.getVoices();
                    this.speechInstance.voice = voices.find(v => v.lang.includes('IN') || v.name.includes('Google')) || voices[0];
                    this.speechInstance.rate = 0.9;

                    this.speechInstance.onend = () => {
                        this.isSpeaking = false;
                        document.getElementById('speak-report-btn').innerHTML = '<i class="fas fa-volume-up"></i> Play Audio';
                    };

                    window.speechSynthesis.speak(this.speechInstance);
                    this.isSpeaking = true;
                    document.getElementById('speak-report-btn').innerHTML = '<i class="fas fa-stop-circle"></i> Stop Audio';
                }
            },

            toggleFollowUpUI: function () {
                const container = document.getElementById('follow-up-container');
                container.style.display = container.style.display === 'none' ? 'flex' : 'none';
            },

            sendFollowUpQuestion: async function () {
                const input = document.getElementById('follow-up-input');
                const chat = document.getElementById('follow-up-chat');
                const question = input.value.trim();
                if (!question) return;

                input.value = "";
                chat.innerHTML += `<p><strong>You:</strong> ${question}</p>`;
                chat.scrollTo(0, chat.scrollHeight);

                try {
                    const response = await fetch(`${this.API_BASE_URL}/ask-leaf-followup`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question: question, report: this.currentReportText })
                    });
                    const data = await response.json();
                    chat.innerHTML += `<p style="color: var(--primary-color);"><strong>AI:</strong> ${data.answer}</p>`;
                } catch (err) {
                    chat.innerHTML += `<p style="color: red;">Error getting answer.</p>`;
                }
                chat.scrollTo(0, chat.scrollHeight);
            },

            startFollowUpVoice: function () {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) return alert("Voice recognition not supported in this browser.");

                const rec = new SpeechRecognition();
                rec.lang = 'en-IN';
                rec.onstart = () => { document.getElementById('follow-up-input').placeholder = "Listening..."; };
                rec.onresult = (e) => {
                    const transcript = e.results[0][0].transcript;
                    document.getElementById('follow-up-input').value = transcript;
                    this.sendFollowUpQuestion();
                };
                rec.onend = () => { document.getElementById('follow-up-input').placeholder = "Type your question here..."; };
                rec.start();
            },

            speakReport: function (text) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const cleanText = text.replace(/###/g, '').replace(/\*/g, '').replace(/-/g, '').trim();
                    const utterance = new SpeechSynthesisUtterance(cleanText);
                    const voices = window.speechSynthesis.getVoices();
                    const tamilVoice = voices.find(voice => voice.lang.includes('ta'));
                    if (tamilVoice) {
                        utterance.voice = tamilVoice;
                        utterance.lang = 'ta-IN';
                    } else {
                        utterance.lang = 'en-US';
                    }
                    utterance.rate = 0.9;
                    utterance.pitch = 1.0;
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert("Sorry, your browser doesn't support text-to-speech.");
                }
            },

            getWeatherByLocation: function () {
                if ("geolocation" in navigator) {
                    this.showLoadingOverlay(true);
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        const { latitude, longitude } = position.coords;
                        this.fetchWeather({ lat: latitude, lon: longitude });
                    }, () => {
                        document.getElementById('weather-output').innerHTML = "<p style='color:red;'>Could not get your location. Please enable location services.</p>";
                        this.showLoadingOverlay(false);
                    });
                } else {
                    document.getElementById('weather-output').innerHTML = "<p style='color:red;'>Geolocation is not supported by your browser.</p>";
                }
            },

            getWeatherByCity: function () {
                const city = document.getElementById('city-search-input').value;
                if (!city) {
                    alert("Please enter a city name.");
                    return;
                }
                this.saveRecentSearch(city);
                this.showLoadingOverlay(true);
                this.fetchWeather({ city: city });
            },

            saveRecentSearch: function (city) {
                let searches = JSON.parse(localStorage.getItem('recent_weather_searches') || '[]');
                if (!searches.includes(city)) {
                    searches.unshift(city);
                    localStorage.setItem('recent_weather_searches', JSON.stringify(searches.slice(0, 5)));
                }
            },

            fetchWeather: async function (params) {
                const outputDiv = document.getElementById('weather-output');
                let queryString = '';
                if (params.lat && params.lon) {
                    queryString = `lat=${params.lat}&lon=${params.lon}`;
                } else if (params.city) {
                    queryString = `city=${encodeURIComponent(params.city)}`;
                } else {
                    // Fallback to a default city if nothing provided
                    queryString = `city=Coimbatore`;
                }
                try {
                    const response = await fetch(`${this.API_BASE_URL}/weather?${queryString}`);
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);

                    // Stop any existing clock interval
                    if (this.weatherClockInterval) clearInterval(this.weatherClockInterval);

                    this.displayFullWeatherData(data);

                    // Fetch AI Insights in parallel
                    this.fetchWeatherAIIntelligence(data);

                } catch (e) {
                    outputDiv.innerHTML = `<div class="weather-card-premium" style="grid-column: span 6; text-align: center;"><p style="color:red;">Error: ${e.message}</p><button onclick="App.getWeatherByLocation()" class="btn">Retry GPS</button></div>`;
                } finally {
                    this.showLoadingOverlay(false);
                }
            },

            fetchWeatherAIIntelligence: async function (weatherData) {
                const city = weatherData.city_name;
                const aiContainer = document.getElementById('weather-ai-content');
                if (!aiContainer) return;

                try {
                    const response = await fetch(`${this.API_BASE_URL}/weather-intelligence`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ weather: weatherData, city: city })
                    });
                    const aiData = await response.json();

                    aiContainer.innerHTML = `
                        <div><strong>Summary:</strong> ${aiData.summary}</div>
                        <div><strong>Wear:</strong> ${aiData.what_to_wear}</div>
                        <div><strong>Agri Impact:</strong> ${aiData.agri_impact}</div>
                        <div><strong>Fun Fact:</strong> ${aiData.fun_fact}</div>
                    `;
                } catch (error) {
                    aiContainer.innerHTML = "<div>AI insights currently charging... Check back soon!</div>";
                }
            },

            getWeatherIconClass: function (weatherData) {
                if (!weatherData) return 'fa-question-circle';
                const id = weatherData.id;
                if (id >= 200 && id <= 232) return 'fa-bolt'; // Thunderstorm
                if (id >= 300 && id <= 321) return 'fa-cloud-rain'; // Drizzle
                if (id >= 500 && id <= 531) return 'fa-cloud-showers-heavy'; // Rain
                if (id >= 600 && id <= 622) return 'fa-snowflake'; // Snow
                if (id >= 701 && id <= 781) return 'fa-smog'; // Atmosphere (mist, smoke, etc.)
                if (id === 800) return 'fa-sun'; // Clear
                if (id === 801) return 'fa-cloud-sun'; // Few clouds
                if (id >= 802 && id <= 804) return 'fa-cloud'; // Scattered/Broken/Overcast clouds
                return 'fa-cloud-sun'; // Default
            },

            displayFullWeatherData: function (data) {
                const outputDiv = document.getElementById('weather-output');
                const intel = data.intelligence || {};
                const aqi = data.air_quality.main.aqi;

                // --- Sun Path Calculation ---
                const now = new Date();
                const sunrise = new Date(data.current.sunrise * 1000);
                const sunset = new Date(data.current.sunset * 1000);
                const totalDay = sunset - sunrise;
                const elapsed = now - sunrise;
                let sunPos = (elapsed / totalDay) * 100;
                sunPos = Math.max(0, Math.min(100, sunPos));
                const sunTop = Math.sin((sunPos / 100) * Math.PI) * 100;

                // --- Farmer Risk Calculation ---
                let risk = 10;
                if (data.current.wind_speed > 5) risk += 30;
                if (data.current.weather[0].main.includes('Rain')) risk += 50;
                if (data.current.uvi > 7) risk += 20;
                risk = Math.min(100, risk);

                // --- Broadcast Stream UI (V5 24/7 Edition) ---
                const isRain = data.current.weather[0].main.includes('Rain');
                const isStorm = data.current.weather[0].main.includes('Storm');



                let html = `
                <div class="weather-hub-grid">
                    
                    <!-- NEW: 24/7 LIVE BROADCAST STREAM -->
                    <div class="broadcast-container">
                        <div class="radar-scanner"></div>
                        <div class="broadcast-vignette"></div>

                        <div class="broadcast-overlay-top">
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <div class="live-tag"><i class="fas fa-circle"></i> LIVE BROADCAST</div>
                                <div class="agro-tv-logo"><i class="fas fa-leaf"></i> AGRO- INDIA</div>
                            </div>
                            <div class="broadcast-clock-digital" id="broadcast-live-clock">00:00:00</div>
                        </div>

                        <div class="breaking-banner ${isRain || isStorm ? 'active' : ''}">
                            <div class="label">BREAKING WEATHER</div>
                            <div style="color: white; font-weight: 700; font-size: 1rem;">
                                ${isRain ? 'HEAVY RAINFALL SCANNED IN REGION' : isStorm ? 'STORM CELL DETECTED - MONITORING SATELLITE' : ''}
                            </div>
                        </div>

                        <!-- VIRTUAL STUDIO FEED (Always Live) -->
                        <div class="virtual-studio-overlay">
                            <div class="live-weather-badges">
                                <div class="stream-badge">
                                    <i class="fas fa-temperature-high" style="color: #ff3131;"></i>
                                    <div class="info">
                                        <span style="font-size: 0.7rem; opacity: 0.6;">CURRENT TEMP</span>
                                        <span class="val">${Math.round(data.current.temp)}Â°C</span>
                                    </div>
                                </div>
                                <div class="stream-badge">
                                    <i class="fas fa-satellite-dish" style="color: #00f6ff;"></i>
                                    <div class="info">
                                        <span style="font-size: 0.7rem; opacity: 0.6;">SATELLITE STATUS</span>
                                        <span class="val">NOMINAL</span>
                                    </div>
                                </div>
                                <div class="stream-badge">
                                    <i class="fas fa-wind" style="color: #39ff14;"></i>
                                    <div class="info">
                                        <span style="font-size: 0.7rem; opacity: 0.6;">WIND SPEED</span>
                                        <span class="val">${data.current.wind_speed} m/s</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 24/7 DYNAMIC NEWS TICKER -->
                        <div class="news-ticker-v5">
                            <div class="ticker-label">NEWS FLASH</div>
                            <div class="ticker-content-wrapper" id="broadcast-ticker">
                                <div class="ticker-item">NATIONAL MONITOR: ${data.city_name} reporting ${data.current.weather[0].description} <span class="temp">${Math.round(data.current.temp)}Â°C</span></div>
                                <div class="ticker-item">AGRI ADVISORY: Frost risk in northern regions is currently ${intel.frost_risk} <span class="temp">ALERT</span></div>
                                <div class="ticker-item">SATELLITE INTEL: Visibility across the district stands at ${intel.visibility_km} <span class="temp">LIVE</span></div>
                                <div class="ticker-item">IMD UPDATE: Expected shifts in localized wind patterns over next 24 hours.</div>
                                <!-- Second half for loop -->
                                <div class="ticker-item">NATIONAL MONITOR: ${data.city_name} reporting ${data.current.weather[0].description} <span class="temp">${Math.round(data.current.temp)}Â°C</span></div>
                                <div class="ticker-item">AGRI ADVISORY: Frost risk in northern regions is currently ${intel.frost_risk} <span class="temp">ALERT</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- CARD 1: HERO VIEW (Mini) -->
                    <div class="weather-card-premium weather-hero">
                        <div class="header-info">
                            <div class="city-clock">
                                <h2>${data.city_name}</h2>
                                <div class="live-clock" id="live-weather-clock">00:00:00</div>
                            </div>
                            <div class="main-icon">
                                <i class="fas ${this.getWeatherIconClass(data.current.weather[0])} fa-beat" style="font-size: 3.5rem; color: var(--primary-color);"></i>
                            </div>
                        </div>
                        <div class="temp-main">
                            ${Math.round(data.current.temp)}<sup>Â°C</sup>
                        </div>
                        <div style="font-size: 1.1rem; color: #fff; font-weight: 600; text-transform: uppercase;">
                            ${data.current.weather[0].description} &bull; FEELS LIKE ${Math.round(data.current.feels_like)}Â°
                        </div>
                    </div>

                    <!-- CARD 2: MAP RADAR SCAN -->
                    <div class="weather-card-premium weather-map" style="position: relative;">
                        <div class="map-layer-controls">
                            <button class="layer-btn active" onclick="App.switchMapLayer('${data.lat}','${data.lon}', 'wind')">WIND</button>
                            <button class="layer-btn" onclick="App.switchMapLayer('${data.lat}','${data.lon}', 'clouds')">CLOUDS</button>
                            <button class="layer-btn" onclick="App.switchMapLayer('${data.lat}','${data.lon}', 'temp')">TEMP</button>
                        </div>
                        <iframe id="windy-iframe" 
                            src="https://embed.windy.com/embed2.html?lat=${data.lat}&lon=${data.lon}&zoom=8&level=surface&overlay=wind&menu=&message=true&marker=true&calendar=now&pressure=&type=map&location=coordinates&detail=&detailLat=${data.lat}&detailLon=${data.lon}&metricWind=default&metricTemp=default&radarRange=-1&key=UmxitBUllW9OVXZjUHWi5dpz4fxBuNQk">
                        </iframe>
                    </div>

                    <!-- CARD 3: ASTRONOMICAL OBSERVATORY -->
                    <div class="weather-card-premium weather-observatory">
                        <h3 style="color: var(--electric-blue);"><i class="fas fa-satellite"></i> CELESTIAL ALIGNMENT</h3>
                        <div class="sun-path-container">
                            <div class="sun-curve"></div>
                            <div class="sun-icon-dynamic" style="left: ${sunPos}%; top: ${100 - sunTop}%">
                                <i class="fas ${intel.is_night ? 'fa-moon' : 'fa-sun'}"></i>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #aaa; margin-top: 5px;">
                            <span>RISE: ${sunrise.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                            <span>SET: ${sunset.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                        </div>
                        <div class="moon-phase-hero">
                            <i class="fas ${this.getMoonIcon(intel.moon_phase)} moon-icon-graphic"></i>
                            <div>
                                <div style="font-weight: 700; font-size: 1.2rem;">${intel.moon_phase}</div>
                                <div style="font-size: 0.8rem; opacity: 0.6;">Lunar Luminosity: ${Math.round(intel.moon_phase_val * 100)}%</div>
                            </div>
                        </div>
                    </div>

                    <!-- CARD 4: ATMOSPHERIC INTEL CHIPS -->
                    <div class="weather-card-premium" style="grid-column: span 3; background: rgba(0,0,0,0.5);">
                        <h3 style="margin-bottom: 20px;"><i class="fas fa-microchip"></i> ATMOSPHERIC CONSTANTS</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <div class="intel-chip">
                                <span class="label">Visibility</span>
                                <span class="value">${intel.visibility_km}</span>
                            </div>
                            <div class="intel-chip">
                                <span class="label">Dew Point</span>
                                <span class="value">${intel.dew_point_c}</span>
                            </div>
                            <div class="intel-chip">
                                <span class="label">Cloud Coverage</span>
                                <span class="value">${intel.cloud_cover}</span>
                            </div>
                            <div class="intel-chip">
                                <span class="label">Frost Risk</span>
                                <span class="value" style="color: ${intel.frost_risk === 'None' ? 'var(--primary-color)' : '#ff3e3e'}">${intel.frost_risk}</span>
                            </div>
                            <div class="intel-chip">
                                <span class="label">AQI (1-5)</span>
                                <span class="value">${aqi}</span>
                            </div>
                            <div class="intel-chip">
                                <span class="label">Atm. Pressure</span>
                                <span class="value">${data.current.pressure} hPa</span>
                            </div>
                        </div>
                    </div>

                    <!-- CARD 5: HOURLY TRENDS (2 ROWS) -->
                    <div class="weather-card-premium weather-forecast-scroll">
                        <h3><i class="fas fa-wave-square"></i> ATMOSPHERIC FLOW (24H)</h3>
                        <div class="scroll-container-grid">
                            ${(data.hourly || []).slice(0, 24).map(hour => `
                                <div class="forecast-item" style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); padding: 12px;">
                                    <div style="font-size: 0.7rem; opacity: 0.6;">${new Date(hour.dt * 1000).toLocaleTimeString([], { hour: 'numeric' })}</div>
                                    <i class="fas ${this.getWeatherIconClass(hour.weather[0])}" style="font-size: 1.5rem; margin: 10px 0; color: var(--electric-blue);"></i>
                                    <div style="font-weight: 800; font-size: 1.1rem;">${Math.round(hour.temp)}Â°</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- CARD 6: AGRI OPERATION RISK -->
                    <div class="weather-card-premium weather-night-analytics">
                        <h3><i class="fas fa-shield-halved"></i> OPERATION VIABILITY</h3>
                        <p style="font-size: 0.8rem; opacity: 0.7; margin: 10px 0;">Calculated base on wind/rain/UV</p>
                        <div class="risk-gauge">
                            <div class="risk-fill" style="width: ${risk}%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 1.2rem; color: ${risk > 60 ? '#ff3131' : 'var(--primary-color)'};">
                            <span>${risk}% RISK</span>
                            <span>${risk > 60 ? 'CAUTION' : 'OPTIMAL'}</span>
                        </div>
                        <div style="margin-top: 15px; font-size: 0.8rem; opacity: 0.8;">
                            <i class="fas fa-info-circle"></i> ${risk > 60 ? 'Avoid spraying or sensitive harvesting now.' : 'Weather conditions are safe for field work.'}
                        </div>
                    </div>

                    <!-- CARD 8: HIGH-DENSITY NEWS HUB EXTREME -->
                    <div class="news-hub-extreme">
                        <div class="news-header">
                            <h3><i class="fas fa-satellite-dish"></i> GLOBAL & LOCAL ATMOSPHERIC DISPATCHES</h3>
                            <span style="font-size: 0.8rem; color: var(--primary-color);">6+ ARTICLES SYNCED</span>
                        </div>
                        <div id="localized-weather-news" class="news-grid-high-density">
                            <div class="fa-beat"><i class="fas fa-server"></i> Syncing with Global Meteorological Database...</div>
                        </div>
                    </div>
                </div>
                `;

                outputDiv.innerHTML = html;
                outputDiv.style.display = 'block';

                // Initial fetch for news
                this.fetchWeatherNews(data.city_name);

                // --- 24/7 BROADCAST PULSE ENGINE ---
                if (this.weatherClockInterval) clearInterval(this.weatherClockInterval);
                if (this.broadcastPulseInterval) clearInterval(this.broadcastPulseInterval);

                const startBroadcastClocks = () => {
                    const now = new Date();
                    const clockStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });

                    const clockEl1 = document.getElementById('live-weather-clock');
                    const clockEl2 = document.getElementById('broadcast-live-clock');

                    if (clockEl1) clockEl1.textContent = clockStr;
                    if (clockEl2) clockEl2.textContent = clockStr;
                };
                startBroadcastClocks();
                this.weatherClockInterval = setInterval(startBroadcastClocks, 1000);

                // Autonomous Data Refresh (Every 5 minutes)
                this.broadcastPulseInterval = setInterval(() => {
                    console.log("AGRO-TV: Refreshing live stream satellite data...");
                    this.fetchWeather({ lat: data.lat, lon: data.lon }); // Use fetchWeather to re-render everything
                }, 300000); // 5 Minutes
            },

            fetchWeatherNews: async function (city) {
                const newsGrid = document.getElementById('localized-weather-news');
                if (!newsGrid) return;

                const locationLabel = document.querySelector('.city-clock h2')?.textContent || city;
                const searchQueries = [
                    `${locationLabel} weather articles official`,
                    `${city} IMD weather updates`,
                    `India national weather satellite news`,
                    `Agro weather forecast India`
                ];

                let allArticles = [];
                try {
                    for (const query of searchQueries) {
                        const newsRes = await fetch(`${this.API_BASE_URL}/agri-news?q=${encodeURIComponent(query)}`);
                        const newsData = await newsRes.json();
                        if (newsData.articles && newsData.articles.length > 0) {
                            allArticles = [...allArticles, ...newsData.articles];
                            if (allArticles.length >= 12) break;
                        }
                    }

                    let html = '';
                    if (allArticles.length > 0) {
                        const uniqueArticles = Array.from(new Set(allArticles.map(a => a.title)))
                            .map(title => allArticles.find(a => a.title === title))
                            .slice(0, 9);

                        uniqueArticles.forEach(article => {
                            html += `
                                <div class="news-card-v5">
                                    <img src="${article.urlToImage || 'https://images.unsplash.com/photo-1592210633464-e7db0e5c4e43?w=400'}" alt="Weather News">
                                    <div class="news-content">
                                        <h4>${article.title}</h4>
                                        <p>${article.source.name} &bull; ${new Date(article.publishedAt).toLocaleDateString()}</p>
                                        <a href="${article.url}" target="_blank" style="color: var(--primary-color); font-weight: 700; font-size: 0.8rem;">FULL DISPATCH <i class="fas fa-arrow-right"></i></a>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        html += '<p style="grid-column: span 3; text-align: center; color: #888;">Satellite database sync pending...</p>';
                    }
                    newsGrid.innerHTML = html;
                } catch (e) {
                    newsGrid.innerHTML = '<p>Local intelligence feed offline.</p>';
                }
            },

            getMoonIcon: function (phase) {
                if (phase.includes('New')) return 'fa-circle-dot';
                if (phase.includes('Crescent')) return 'fa-moon';
                if (phase.includes('Quarter')) return 'fa-moon';
                if (phase.includes('Gibbous')) return 'fa-moon';
                if (phase.includes('Full')) return 'fa-circle';
                return 'fa-moon';
            },

            switchMapLayer: function (lat, lon, layer) {
                const iframe = document.getElementById('windy-iframe');
                if (!iframe) return;
                iframe.src = `https://embed.windy.com/embed2.html?lat=${lat}&lon=${lon}&zoom=8&level=surface&overlay=${layer}&menu=&message=true&marker=true&calendar=now&pressure=&type=map&location=coordinates&detail=&detailLat=${lat}&detailLon=${lon}&metricWind=default&metricTemp=default&radarRange=-1&key=UmxitBUllW9OVXZjUHWi5dpz4fxBuNQk`;

                // Update active state
                document.querySelectorAll('.layer-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
            },

            // --- MODIFIED --- This is the updated function
            getPrices: async function () {
                const veg = document.getElementById('veg-name').value;
                const location = document.getElementById('veg-location').value;
                const priceList = document.getElementById('price-list');
                const vegInfoContainer = document.getElementById('vegetable-info-details');

                // Hide previous info and clear price list
                vegInfoContainer.style.display = 'none';
                priceList.innerHTML = '';

                if (!veg || !location) {
                    priceList.innerHTML = "<p style='color: red;'>Please enter both Vegetable Name and Market/City.</p>";
                    return;
                }

                this.showLoadingOverlay(true);

                try {
                    // --- Task 1: Fetch Price ---
                    const priceResponse = await fetch(`${this.API_BASE_URL}/prices?vegetable=${encodeURIComponent(veg)}&location=${encodeURIComponent(location)}`);
                    if (!priceResponse.ok) {
                        const errorData = await priceResponse.json();
                        throw new Error(errorData.error || 'Failed to fetch prices.');
                    }
                    const priceData = await priceResponse.json();
                    if (priceData.prices && priceData.prices.length > 0) {
                        const priceInfo = priceData.prices[0];
                        priceList.innerHTML = `<div style="text-align: left; font-size: 1.1rem;"><strong>${priceInfo.name}</strong> in <strong>${priceInfo.location}</strong><p style="font-size: 1.8rem; font-weight: 600; margin: 10px 0; color: var(--primary-hover);">${priceInfo.price}</p></div>`;
                    } else {
                        priceList.innerHTML = `<p>No price data found for <strong>${veg}</strong> in <strong>${location}</strong>.</p>`;
                    }

                    // --- Task 2: Fetch Vegetable Info ---
                    const infoResponse = await fetch(`${this.API_BASE_URL}/vegetable-info?name=${encodeURIComponent(veg)}`);
                    if (infoResponse.ok) {
                        const infoData = await infoResponse.json();
                        this.displayVegetableInfo(infoData);
                    } else {
                        console.warn('Could not fetch vegetable details, but price is shown.');
                    }

                } catch (error) {
                    priceList.innerHTML = `<p style='color: red;'>Error: ${error.message}.</p>`;
                } finally {
                    this.showLoadingOverlay(false);
                }
            },

            // --- NEW --- This is the new function to display the vegetable info card
            displayVegetableInfo: function (data) {
                const container = document.getElementById('vegetable-info-details');
                document.getElementById('veg-info-image').src = data.image_url || 'https://i.pinimg.com/564x/12/37/c4/1237c44565d7595d52f3e8b0f24c322b.jpg';
                document.getElementById('veg-info-name').textContent = data.name;

                let contentHTML = `
                    <div class="veg-info-section">
                        <h4><i class="fas fa-history"></i> History & Origin</h4>
                        <p>${data.history}</p>
                    </div>
                    
                    <div class="realtime-grid">
                        <div class="realtime-card">
                            <h5><i class="fas fa-map-marker-alt"></i> Nearby Active Markets <span class="status-indicator status-active">LIVE</span></h5>
                            <p style="font-size: 0.85rem; margin: 0;"><strong>Main Market:</strong> 2.5km (Active)<br><strong>Farmers Hub:</strong> 4.8km (Busy)</p>
                        </div>
                        <div class="realtime-card">
                            <h5><i class="fas fa-chart-line"></i> Price Trends <span class="status-indicator status-up">+â‚¹2 Today</span></h5>
                            <p style="font-size: 0.85rem; margin: 0;">Market indicators show a 5% increase in demand this week.</p>
                        </div>
                        <div class="realtime-card">
                            <h5><i class="fas fa-truck-loading"></i> Arrival Status <span class="status-indicator status-active">HIGH</span></h5>
                            <p style="font-size: 0.85rem; margin: 0;">Over 50+ Tonnes arrived in local markets since 6:00 AM.</p>
                        </div>
                        <div class="realtime-card">
                            <h5><i class="fas fa-user-tie"></i> Expert Advice <span class="status-indicator status-active">ONLINE</span></h5>
                            <button class="action-btn" style="width: 100%; margin-top: 5px; height: auto; padding: 5px; font-size: 0.8rem;">
                                <i class="fas fa-comment"></i> Direct Connect
                            </button>
                        </div>
                    </div>

                    <div class="veg-info-section" style="margin-top: 30px;">
                        <h4><i class="fas fa-seedling"></i> Cultivation Guide</h4>
                        <p><strong>Soil:</strong> ${data.cultivation.soil}</p>
                        <p><strong>Water:</strong> ${data.cultivation.water}</p>
                        <p><strong>Climate:</strong> ${data.cultivation.climate}</p>
                    </div>
                    <div class="veg-info-section">
                        <h4><i class="fas fa-apple-alt"></i> Nutritional Facts (per 100g)</h4>
                        <table class="nutrition-table">
                            <tbody>
                                ${data.nutrition.map(item => `<tr><td>${item.nutrient}</td><td>${item.value}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById('veg-info-content').innerHTML = contentHTML;
                container.style.display = 'flex';

                // --- NEW --- AI Spoken Summary for Prices
                this.explainResults('vegetable price and guide', data);
            },


            getPlan: async function () {
                const outputDiv = document.getElementById('planner-output');
                const crop = document.getElementById('crop').value;
                const area = document.getElementById('area').value;
                const location = document.getElementById('location').value; // Get the new location value

                // Check for all new required fields
                if (!crop || !area || !location) {
                    outputDiv.innerHTML = "<p style='color: red;'>Please fill in Crop, Area, and Your Location.</p>";
                    return;
                }

                this.showLoadingOverlay(true);

                try {
                    const response = await fetch(`${this.API_BASE_URL}/planner?crop=${encodeURIComponent(crop)}&area=${encodeURIComponent(area)}&location=${encodeURIComponent(location)}`);

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || 'Failed to generate plan.');
                    }

                    const data = await response.json();

                    let htmlResult = `
            <div style="text-align: left;">
                <h3>${data.plan_summary.title}</h3>
                <p><strong>Suitability:</strong> ${data.plan_summary.suitability}</p>
                <hr>

                <h4>ðŸ’° Cost & Profit Estimation</h4>
                <p><strong>Total Estimated Cost:</strong> ${data.cost_and_profit_estimation.total_estimated_cost}</p>
                <p><strong>Estimated Yield:</strong> ${data.cost_and_profit_estimation.estimated_yield}</p>
                <p><strong>Potential Profit:</strong> <strong style="color: green;">${data.cost_and_profit_estimation.estimated_profit}</strong></p>

                <strong>Cost Breakdown:</strong>
                <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                    ${data.cost_and_profit_estimation.cost_breakdown.map(item => `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 5px;">${item.item}</td>
                            <td style="padding: 5px; text-align: right;">${item.cost}</td>
                        </tr>
                    `).join('')}
                </table>
                <hr>

                <h4>ðŸ—“ï¸ Step-by-Step Guide (${data.step_by_step_guide.timeline_weeks})</h4>
                <ul style="padding-left: 20px;">
                    ${data.step_by_step_guide.steps.map(step => `
                        <li style="margin-bottom: 10px;">
                            <strong>${step.stage}:</strong><br>
                            ${step.action}
                        </li>
                    `).join('')}
                </ul>
            </div>
        `;

                    outputDiv.innerHTML = htmlResult;

                } catch (e) {
                    outputDiv.innerHTML = `<p style='color: red;'>Error: ${e.message}</p>`;
                } finally {
                    this.showLoadingOverlay(false);
                }
            },

            showSellerForm: function () {
                document.getElementById('buysell-choice-wrapper').style.display = 'none';
                document.getElementById('seller-form-container').style.display = 'block';
            },

            showBuysellChoice: function () {
                document.getElementById('seller-form-container').style.display = 'none';
                document.getElementById('buysell-choice-wrapper').style.display = 'flex';
            },

            redirectToBuyerPage: function () {
                window.location.href = '/buyer';
            },

            submitSellerItem: async function () {
                const sellerName = document.getElementById('seller-name').value;
                const itemName = document.getElementById('seller-item-name').value;
                const price = document.getElementById('seller-price').value;
                const imageFile = document.getElementById('seller-item-image').files[0];
                const location = document.getElementById('seller-location').value;
                const category = document.getElementById('seller-category').value;
                const statusDiv = document.getElementById('seller-submit-status');
                const loadingOverlay = document.getElementById('loading-overlay');
                if (!sellerName || !itemName || !price || !imageFile || !location || !category) {
                    statusDiv.innerHTML = '<p style="color:red;">Please fill all fields, select a category, and upload an image.</p>';
                    return;
                }
                loadingOverlay.style.display = 'flex';
                statusDiv.innerHTML = '<p style="color:blue;">Uploading product image...</p>';
                try {
                    const formData = new FormData();
                    formData.append('item_image', imageFile);
                    const imageUploadResponse = await fetch(`${this.API_BASE_URL}/upload-item-image`, { method: 'POST', body: formData });
                    if (!imageUploadResponse.ok) throw new Error('Image upload failed.');
                    const imageUploadResult = await imageUploadResponse.json();
                    const imageUrl = imageUploadResult.imageUrl;
                    statusDiv.innerHTML = '<p style="color:blue;">Image uploaded. Saving details...</p>';
                    const itemData = { sellerName, itemName, itemPrice: parseFloat(price), itemImageUrl: imageUrl, sellerLocation: location, category };
                    const addItemResponse = await fetch(`${this.API_BASE_URL}/add-item`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(itemData) });
                    if (!addItemResponse.ok) throw new Error('Failed to save item details.');
                    const addItemResult = await addItemResponse.json();
                    statusDiv.innerHTML = `<p style="color:green;">${addItemResult.message}</p>`;
                    document.getElementById('seller-name').value = '';
                    document.getElementById('seller-item-name').value = '';
                    document.getElementById('seller-price').value = '';
                    document.getElementById('seller-item-image').value = '';
                    document.getElementById('seller-location').value = '';
                    document.getElementById('seller-category').value = '';
                } catch (error) {
                    statusDiv.innerHTML = `<p style="color:red;">An error occurred: ${error.message}</p>`;
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            },

            getTutorials: async function (query) {
                const outputDiv = document.getElementById('tutorials-output');
                const searchQuery = query || document.getElementById('tutorial-search-input').value;

                if (!searchQuery) {
                    outputDiv.innerHTML = "<p style='text-align:center;'>Please enter a topic to search for tutorials.</p>";
                    return;
                }

                this.showLoadingOverlay(true);
                outputDiv.innerHTML = '';

                try {
                    console.log(`Searching for YouTube videos with query: "${searchQuery}"`);

                    const videos = [
                        { title: "Complete Guide to Tomato Farming", channel_name: "Farming Guruji", url: "https://www.youtube.com/watch?v=example1" },
                        { title: "Organic Pest Control Methods", channel_name: "Green Earth", url: "https://www.youtube.com/watch?v=example2" },
                        { title: "Advanced Drip Irrigation System", channel_name: "AgriTech Innovators", url: "https://www.youtube.com/watch?v=example3" },
                        { title: "How to Prepare Soil for Planting", channel_name: "Farmer's Friend", url: "https://www.youtube.com/watch?v=example4" }
                    ];

                    let tutorialsHTML = '<div class="tutorials-grid">';
                    videos.forEach(video => {
                        tutorialsHTML += `
                            <a href="${video.url}" target="_blank" class="tutorial-card">
                                <div class="tutorial-card-thumbnail">
                                    <img src="https://i.ytimg.com/vi/${video.url.split('v=')[1]}/hqdefault.jpg" alt="${video.title}">
                                     <i class="fas fa-play play-icon"></i>
                                </div>
                                <div class="tutorial-card-content">
                                    <h4>${video.title}</h4>
                                    <p>${video.channel_name}</p>
                                </div>
                            </a>
                        `;
                    });
                    tutorialsHTML += '</div>';
                    outputDiv.innerHTML = tutorialsHTML;

                } catch (error) {
                    outputDiv.innerHTML = `<p style="color:red; text-align:center;">Error fetching tutorials: ${error.message}</p>`;
                } finally {
                    this.showLoadingOverlay(false);
                }

            },

            openNewsModal: function (url) {
                if (url.includes("youtube.com/watch")) {
                    const videoId = url.split('v=')[1].split('&')[0];
                    const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
                    document.getElementById('news-iframe').src = embedUrl;
                    document.getElementById('news-modal').style.display = 'flex';
                } else {
                    window.open(url, '_blank', 'noopener,noreferrer');
                }
            },

            closeNewsModal: function () {
                document.getElementById('news-iframe').src = '';
                document.getElementById('news-modal').style.display = 'none';
            },

            openImageModal: function (src) {
                document.getElementById('full-image').src = src;
                document.getElementById('image-modal-overlay').style.display = 'flex';
            },

            closeImageModal: function () {
                document.getElementById('image-modal-overlay').style.display = 'none';
                document.getElementById('full-image').src = '';
            },

            initDashboardSlider: function () {
                // This function remains for the desktop view
            },

            showLoadingOverlay: function (show) {
                document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
            },

            // NEW functions for mobile login page
            setupMobileLoginView: function () {
                if (window.innerWidth > 768) return; // Only for mobile

                const signInForm = document.querySelector('.sign-in-container');
                const signUpForm = document.querySelector('.sign-up-container');
                const toggleContainer = document.querySelector('.mobile-toggle-forms');


                signInForm.style.display = 'flex';
                signUpForm.style.display = 'none';
                toggleContainer.style.display = 'block';


                document.getElementById('mobile-toggle-text').textContent = "Don't have an account? ";

                document.getElementById('mobile-toggle-btn').textContent = "Sign Up";
            },

            toggleMobileForms: function () {
                const signInForm = document.querySelector('.sign-in-container');
                const signUpForm = document.querySelector('.sign-up-container');
                const toggleText = document.getElementById('mobile-toggle-text');
                const toggleBtn = document.getElementById('mobile-toggle-btn');

                const isSignInVisible = signInForm.style.display === 'flex';

                if (isSignInVisible) {
                    signInForm.style.display = 'none';
                    signUpForm.style.display = 'flex';
                    toggleText.textContent = "Already have an account? ";
                    toggleBtn.textContent = "Sign In";
                } else {
                    signInForm.style.display = 'flex';
                    signUpForm.style.display = 'none';
                    toggleText.textContent = "Don't have an account? ";
                    toggleBtn.textContent = "Sign Up";
                }
            },

            toggleVoiceAssistant: function () {
                const btn = document.querySelector('.voice-assistant-btn');
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

                if (!SpeechRecognition) {
                    alert("Voice Assistant is not supported in this browser. Try Chrome.");
                    return;
                }

                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                    return;
                }

                this.recognition = new SpeechRecognition();
                // Set language to Tamil primarily, it still recognizes English well for cities
                this.recognition.lang = 'ta-IN';
                this.recognition.interimResults = false;

                this.recognition.onstart = () => {
                    this.isListening = true;
                    btn.classList.add('listening');
                    btn.querySelector('span').textContent = 'Listening';
                };

                this.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    console.log("Voice Input:", transcript);
                    this.processVoiceIntelligence(transcript);
                };

                this.recognition.onerror = (event) => {
                    console.error("Speech Recognition Error:", event.error);
                    this.isListening = false;
                    btn.classList.remove('listening');
                    btn.querySelector('span').textContent = 'AI Voice';
                };

                this.recognition.onend = () => {
                    this.isListening = false;
                    btn.classList.remove('listening');
                    btn.querySelector('span').textContent = 'AI Voice';
                };

                this.recognition.start();
            },

            processVoiceIntelligence: async function (transcript) {
                this.showLoadingOverlay(true);
                try {
                    const response = await fetch('/voice-intelligence', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ transcript })
                    });
                    const data = await response.json();

                    if (data.type === 'command') {
                        this.executeCommand(data);
                    } else {
                        this.addChatMessage('incoming', data.answer);
                        if (!document.body.classList.contains("show-chatbot")) {
                            document.body.classList.add("show-chatbot");
                        }
                    }

                    if (data.speech) {
                        this.speak(data.speech);
                    }

                } catch (error) {
                    console.error("Voice Intel Error:", error);
                } finally {
                    this.showLoadingOverlay(false);
                }
            },

            executeCommand: function (data) {
                if (data.action === 'weather') {
                    this.showSection('weather');
                    if (data.params && data.params.city) {
                        document.getElementById('city-search-input').value = data.params.city;
                        this.getWeatherByCity();
                    }
                } else if (data.action === 'disease') {
                    this.showSection('disease');
                } else if (data.action === 'price') {
                    this.showSection('prices');
                    if (data.params && data.params.vegetable && data.params.location) {
                        document.getElementById('veg-name-input').value = data.params.vegetable;
                        document.getElementById('market-city-input').value = data.params.location;
                        this.getMarketPrices();
                    }
                } else if (data.action === 'planner') {
                    this.showSection('planner');
                } else if (data.action === 'news') {
                    this.showSection('news');
                } else if (data.action === 'loan') {
                    this.showSection('loan');
                }
            },

            speak: function (text) {
                if (!window.speechSynthesis) return;

                // Cancel any ongoing speech
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);

                // Try to find a nice Indian English or Tamil voice
                const voices = window.speechSynthesis.getVoices();
                const preferredVoice = voices.find(v => v.lang.includes('ta-IN')) || voices.find(v => v.lang.includes('en-IN')) || voices[0];

                if (preferredVoice) utterance.voice = preferredVoice;
                utterance.pitch = 1.0;
                utterance.rate = 0.9;

                window.speechSynthesis.speak(utterance);
            },

            explainResults: async function (type, data) {
                try {
                    const response = await fetch('/explain-results', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type, data })
                    });
                    const result = await response.json();
                    if (result.explanation) {
                        this.speak(result.explanation);
                    }
                } catch (error) {
                    console.error("Explain Results Error:", error);
                }
            },

            toggleLangDropdown: function () {
                const dropdown = document.getElementById('lang-dropdown');
                dropdown.classList.toggle('active');
            },

            // --- FULLSCREEN IMMERSIVE TRIGGER ---
            launchImmersiveMode: function () {
                const doc = document.documentElement;
                if (doc.requestFullscreen) {
                    doc.requestFullscreen();
                } else if (doc.mozRequestFullScreen) {
                    doc.mozRequestFullScreen();
                } else if (doc.webkitRequestFullscreen) {
                    doc.webkitRequestFullscreen();
                } else if (doc.msRequestFullscreen) {
                    doc.msRequestFullscreen();
                }

                const overlay = document.getElementById('fullscreen-launch-overlay');
                if (overlay) {
                    overlay.style.opacity = '0';
                    setTimeout(() => overlay.style.display = 'none', 800);
                }
            },

            filterLanguages: function () {
                const search = document.getElementById('lang-search-input').value.toLowerCase();
                const items = document.querySelectorAll('.lang-item');
                items.forEach(item => {
                    const name = item.innerText.toLowerCase();
                    item.style.display = name.includes(search) ? 'flex' : 'none';
                });
            },

            selectLanguage: function (code, name) {
                const combo = document.querySelector('.goog-te-combo');
                if (combo) {
                    combo.value = code;
                    combo.dispatchEvent(new Event('change'));
                    document.getElementById('current-lang-label').innerText = name;
                    this.toggleLangDropdown();

                    // Save to recent
                    let recent = JSON.parse(localStorage.getItem('recent_langs') || '[]');
                    recent = [code, ...recent.filter(c => c !== code)].slice(0, 3);
                    localStorage.setItem('recent_langs', JSON.stringify(recent));
                    this.renderLanguageList();
                } else {
                    console.warn("Google Translate combo box not found yet.");
                }
            },

            renderLanguageList: function () {
                const list = document.getElementById('lang-list');
                const recentCodes = JSON.parse(localStorage.getItem('recent_langs') || '[]');

                let html = '';

                // Render Recent first
                if (recentCodes.length > 0) {
                    recentCodes.forEach(code => {
                        const lang = this.languages.find(l => l.code === code);
                        if (lang) {
                            html += `<div class="lang-item recent" onclick="App.selectLanguage('${lang.code}', '${lang.name}')">${lang.name}</div>`;
                        }
                    });
                    html += '<div style="border-bottom: 1px solid #333; margin: 5px 0;"></div>';
                }

                // Render all
                this.languages.slice().sort((a, b) => a.name.localeCompare(b.name)).forEach(lang => {
                    html += `<div class="lang-item" onclick="App.selectLanguage('${lang.code}', '${lang.name}')">${lang.name}</div>`;
                });

                list.innerHTML = html;
            },

            initLangSelector: function () {
                this.renderLanguageList();

                // Sync the label with the actual active language on load
                const syncLang = setInterval(() => {
                    const combo = document.querySelector('.goog-te-combo');
                    if (combo && combo.value) {
                        const lang = this.languages.find(l => l.code === combo.value);
                        if (lang) {
                            document.getElementById('current-lang-label').innerText = lang.name;
                            clearInterval(syncLang);
                        }
                    }
                }, 500);
                setTimeout(() => clearInterval(syncLang), 10000); // Try for 10s

                // Close dropdown on outside click
                window.onclick = (event) => {
                    if (!event.target.closest('.custom-lang-selector') && !event.target.closest('.lang-btn')) {
                        const drp = document.getElementById('lang-dropdown');
                        if (drp) drp.classList.remove('active');
                    }
                };
            }
        };

        App.init();
    </script>
</body>

</html>
